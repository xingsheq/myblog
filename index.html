<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="老祁的笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="老祁笔记">
<meta property="og:url" content="http://rockynote.com/index.html">
<meta property="og:site_name" content="老祁笔记">
<meta property="og:description" content="老祁的笔记">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="老祁笔记">
<meta name="twitter:description" content="老祁的笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rockynote.com/"/>





  <title>老祁笔记</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-105730821-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">老祁笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Rocky's notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/08/java-log/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/java-log/" itemprop="url">java日志体系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T13:05:28+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3rd-party-jars/" itemprop="url" rel="index">
                    <span itemprop="name">3rd party jars</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/08/java-log/" class="leancloud_visitors" data-flag-title="java日志体系">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>java有很多种第三方日志实现，目前常用的是slf4j，要使用slf4j需要3个jar</p>
<ul>
<li>日志框架：sfl4j-api</li>
<li>日志实现：log4j,logback,log4j2,jul,jcl等</li>
<li>桥接器：每种日志实现有一个对应的sfl4j桥接器</li>
</ul>
<h1 id="java日志体系"><a href="#java日志体系" class="headerlink" title="java日志体系"></a>java日志体系</h1><h2 id="log框架"><a href="#log框架" class="headerlink" title="log框架"></a>log框架</h2><p>框架只提供接口，并不提供具体实现，常用框架有：</p>
<ul>
<li><p>java commons-logging（JCL）：动态适配器模式，class.forName(adapterClassName)</p>
<p>Commons logging是通过动态查找机制，在程序运行时，使用自己的ClassLoader寻找和载入本地具体的实现。由于OSGi不同的插件使用独立的ClassLoader，OSGI的这种机制保证了插件互相独立, 其机制限制了commons logging在OSGi中的正常使用。</p>
</li>
<li><p>slf4j：简单日志门面，桥接模式</p>
</li>
</ul>
<h2 id="log具体实现"><a href="#log具体实现" class="headerlink" title="log具体实现"></a>log具体实现</h2><ul>
<li>log4j:依赖disruptor并发编程</li>
<li>log4j2</li>
<li>logback</li>
<li>jul：java.util.logging</li>
<li>jcl：java commons-logging内部有个简单的实现，不常用</li>
</ul>
<h2 id="slf4j桥接器"><a href="#slf4j桥接器" class="headerlink" title="slf4j桥接器"></a>slf4j桥接器</h2><p>桥接slf4j与具体实现</p>
<ul>
<li>log4j：slf4j-log4j12</li>
<li>log4j2：log4j-slf4j-impl</li>
<li>logback：logback-classic</li>
<li>jul：slf4j-jdk</li>
<li>jcl：slf4j-jcl：桥接jcl，jcl适配log4j，如果没有引入log4j，适配jul</li>
</ul>
<h2 id="slf4j替换器"><a href="#slf4j替换器" class="headerlink" title="slf4j替换器"></a>slf4j替换器</h2><p>用于整合统一日志框架，替代老的对应的框架，如jcl-over-slf4j.jar，类名和jcl一样，使用时删除jcl的jar，则日志框架被替换为slf4j</p>
<ul>
<li>jcl-over-slf4j</li>
<li>jul-over-slf4j</li>
<li>log4j-over-slf4j</li>
</ul>
<h1 id="问题痛点"><a href="#问题痛点" class="headerlink" title="问题痛点"></a>问题痛点</h1><ul>
<li>osgi中存在问题，由于OSGi不同的插件使用独立的ClassLoader，OSGI的这种机制保证了插件互相独立, 但限制了commons logging在OSGi中的正常使用。因为commons logging使用自己的ClassLoader寻找和载入本地具体的实现。</li>
<li>框架和应用使用不同实现</li>
</ul>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>spring采用jcl+log4j，应用使用slf4j+log4j2，整合到一个日志文件，现状：</p>
<ul>
<li>app:slf4j+log4j2-日志1</li>
<li>框架：jcl+log4j-日志2</li>
<li>容器：jul（java.util.logging）-日志2</li>
</ul>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><ul>
<li>方案1：slf4j桥接log4j，app不使用log4j2</li>
<li>方案2：jcl连到slf4j，jcl-over-slf4j，删除jcl+log4j</li>
</ul>
<p>jcl-over-slf4j：替换器，替代jcl，类名和jcl一样，类似狸猫换太子，类似的有jul-over-slf4j，log4j-over-slf4j</p>
<h1 id="log4j2配置文件样例"><a href="#log4j2配置文件样例" class="headerlink" title="log4j2配置文件样例"></a>log4j2配置文件样例</h1><p>log4j2+slf4j配置方案：logger-appender-file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;Configuration status=info&gt; slf4j自身状态日志</div><div class="line">    &lt;appenders&gt;</div><div class="line">        &lt;Console/&gt;</div><div class="line">        &lt;file/&gt;</div><div class="line">        &lt;rollingFile&gt;</div><div class="line">    &lt;/appenders&gt;</div><div class="line"></div><div class="line">	&lt;loggers&gt;</div><div class="line">      &lt;root level=&gt; 所有</div><div class="line">          &lt;appender ref=console&gt;</div><div class="line">          &lt;appender ref=file&gt;</div><div class="line">      &lt;/root&gt;</div><div class="line">      &lt;logger name=&quot;com.xx&quot;&gt;&lt;/logger&gt;</div><div class="line">      &lt;sysnRoot&gt;</div><div class="line">	&lt;/loggers&gt;</div><div class="line">&lt;/Configuration&gt;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/08/Future-And-Worker-Pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/Future-And-Worker-Pattern/" itemprop="url">多线程并发模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T11:20:06+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/theory/" itemprop="url" rel="index">
                    <span itemprop="name">theory</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/08/Future-And-Worker-Pattern/" class="leancloud_visitors" data-flag-title="多线程并发模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Future模式"><a href="#Future模式" class="headerlink" title="Future模式"></a>Future模式</h1><p>​    异步非阻塞返回请求，直接返回的是包装过的请求结果，实际在获取结果时阻塞，比如：汇总多个存储过程的结果。</p>
<ol>
<li>先返回包装的对象，包装对象{set（实际对象） synchronized get{ 实际对象.get()} } 有点像适配器模式</li>
<li>调用存储过程时，直接返回包装对象，同时启动计算线程，把计算结果set到包装对象</li>
<li>调用包装对象get获得结果时，判断是否已set实际对象，否则阻塞</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">//伪代码</div><div class="line">public class FutureData implements Data &#123;  </div><div class="line"></div><div class="line">    protected RealData realData =null;  </div><div class="line">    protected boolean isReady = false;  </div><div class="line"></div><div class="line">    public synchronized void setRealData(RealData realData)&#123; </div><div class="line">        isReady=true;</div><div class="line">        notifyAll(); </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  synchronized  String getResult() &#123;</div><div class="line">      	while(!isReady)&#123;  </div><div class="line">            try&#123;  </div><div class="line">                wait();  </div><div class="line">            &#125;catch (Exception e)&#123;                    </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        return realData.result;        </div><div class="line">    &#125;    </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;  </div><div class="line"></div><div class="line">    public Data request(final String queryStr)&#123;  </div><div class="line">        final FutureData future = new FutureData();  </div><div class="line">        //开启一个新的线程来构造真实数据  </div><div class="line">        new Thread()&#123;  </div><div class="line">            public void run()&#123;  </div><div class="line">                RealData realData = new RealData(queryStr);  </div><div class="line">                future.setRealData(realData);           </div><div class="line">            &#125;  </div><div class="line">        &#125;.start();  </div><div class="line">        return future;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="MasterWorker模式"><a href="#MasterWorker模式" class="headerlink" title="MasterWorker模式"></a>MasterWorker模式</h1><p>​    并行计算，master负责接收和分配任务，worker负责执行任务，执行完成返回结果到master，master进行汇总计算。</p>
<p>​    适用于大任务分解，并行进行，提高吞吐量。</p>
<ul>
<li>Master：</li>
</ul>
<ul>
<li><ul>
<li><ul>
<li>concurrentLinkedQueue <strong>存job</strong>，</li>
<li>HashMap<string,thread> <strong>存woker线程</strong>，</string,thread></li>
<li>concurrentHashMap<string,object><strong>存worker处理结果</strong></string,object></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Worker：</li>
</ul>
<ul>
<li><ul>
<li><ul>
<li>Runnable，</li>
<li>持有concurrentLinkedQueue的引用，取job</li>
<li>持有concurrentHashMap<string,object>的引用，存结果</string,object></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">//伪代码</div><div class="line">Master&#123;</div><div class="line"></div><div class="line">Master(Worker,workerCount)&#123;</div><div class="line">  worker.setQueue()</div><div class="line">  worker.setConcurrentHashMap()</div><div class="line">  for（workerCount）&#123;</div><div class="line">  	HashMap.put(xx,Thread(worker))//初始化worker线程</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">//接收任务，放入队列</div><div class="line">submit(Task)&#123; queue.add(task)&#125;</div><div class="line"></div><div class="line">execute()&#123;</div><div class="line">   HashMap.for &#123;</div><div class="line">      map.value.start//启动worker线程</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  isComplete()&#123;遍历worker，查看进程状态，都中断则完成&#125;</div><div class="line"></div><div class="line">  getResult()&#123;获得计算结果&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//伪代码</div><div class="line">worker impl Runnable&#123;</div><div class="line"></div><div class="line">  	run()&#123;</div><div class="line">      while(true)&#123;</div><div class="line">          task=q.poll//取任务</div><div class="line">          if(task==null) break;</div><div class="line">          out=handle(task)</div><div class="line">          concurrentHashMap.put(xx,out)//存结果</div><div class="line">  	  &#125;</div><div class="line">	//处理任务</div><div class="line">	out handle(task)&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Guarded-Suspension"><a href="#Guarded-Suspension" class="headerlink" title="Guarded Suspension"></a>Guarded Suspension</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>​    将并行转为串行式并行。Guarded Suspension:意为保护暂停。如字面意思一样。比如当服务器同时处理大量用户请求时，这时丢弃用户请求会影响用户体验。这时可以采让客户端请求排队等候，等前面的处理完之后再来处理后面的用户。这样既不会使得用户请求丢失，也避免了大量请求造成服务器崩溃。感觉有点像消费者生产者模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class Queue &#123;</div><div class="line">    private List queue = new LinkedList();</div><div class="line"></div><div class="line">    public synchronized Request getRequest() &#123;</div><div class="line">        while(queue.size()==0) &#123;</div><div class="line">            try &#123;</div><div class="line">                this.wait();</div><div class="line">            &#125;</div><div class="line">            catch(InterruptedException ie) &#123;</div><div class="line">                return null;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return (Request)queue.remove(0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public synchronized void putRequest(Request request) &#123;</div><div class="line">        queue.add(request);</div><div class="line">        this.notifyAll();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="不变模式"><a href="#不变模式" class="headerlink" title="不变模式"></a>不变模式</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><p>​    在没有同步的多线程环境中，有些对象自创建便不需要被改变，这个时候，我们可以采用不变模式。平常我们见到的元数据的包装类，String、Boolean、Byte、Character、Double、Float、Integer、Long、Short都是使用的是不变模式。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol>
<li>将类定义为final类型，以保证其没有子类继承</li>
<li>将所有属性定义为private私有属性，也用final修饰，使其无法被更改。</li>
<li>拥有至少一个构造函数。</li>
<li>去除所有的setter方法。</li>
</ol>
<h1 id="消费者-生产者模式"><a href="#消费者-生产者模式" class="headerlink" title="消费者-生产者模式"></a>消费者-生产者模式</h1><h2 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h2><p>​    生产者用于提交用户请求，消费者用于解决问题请求。</p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>将生产者和消费者进行解耦</li>
<li>通过内存缓冲区，可以消除了生产者和消费者之间的性能差异。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/08/Design-Pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/Design-Pattern/" itemprop="url">Design-Pattern</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T10:25:59+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/theory/" itemprop="url" rel="index">
                    <span itemprop="name">theory</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/08/Design-Pattern/" class="leancloud_visitors" data-flag-title="Design-Pattern">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设计模式的六大原则SOLID"><a href="#设计模式的六大原则SOLID" class="headerlink" title="设计模式的六大原则SOLID"></a>设计模式的六大原则SOLID</h1><ul>
<li>Single单一职责</li>
<li>Open Close Principle：开闭原则，对扩展开放，对修改关闭</li>
<li>Liskov Substitution Principle：里氏替换原则，派生类可以替换掉基类</li>
<li>Dependence Inversion Principle：依赖倒置，针对对接口编程，依赖于抽象而不依赖于具体，是开闭原则的基础</li>
<li>Interface Segregation Principle：接口隔离原则，最小接口，使用多个隔离的接口，比使用单个接口要好</li>
<li>Demeter/Least Knowledge Principle：迪米特法则，不和陌生人说话，尽量少地与其他实体之间发生相互作用</li>
<li>Composite Reuse Principle：尽量使用合成/聚合的方式，而不是使用继承</li>
</ul>
<h1 id="设计模式分类"><a href="#设计模式分类" class="headerlink" title="设计模式分类"></a>设计模式分类</h1><ul>
<li>创建型：抽工建原单，</li>
<li>结构型：适代外享组装桥。 </li>
<li>行为型：访问者观察迭代策略，备忘录模板记录状态，命令中介解释责任链</li>
</ul>
<p><img src="http://oulmk4pq1.bkt.clouddn.com/pattern/pattern_category.jpg" alt=""></p>
<h1 id="设计模式类图"><a href="#设计模式类图" class="headerlink" title="设计模式类图"></a>设计模式类图</h1><p>类与类之间的关系：<strong>鸡湿衣冠剧组</strong>(继承，实现，依赖，关联，聚合，组合)</p>
<ul>
<li>继承/泛化：Generalization 实线+空三角</li>
<li>实现：Realization 虚线+空三角</li>
<li>依赖：Dependency 虚线+箭头  不持有引用，比如局部变量，函数参数， 返回值</li>
<li>关联：Association 实线+箭头 持有引用，比如成员变量</li>
<li>聚合：Aggregation 实线+空菱形（整体）+箭头（局部），整体与局部，比如成员变量</li>
<li>组合：Composition 实线+实菱形（整体）+箭头（局部），整体与局部，共生死</li>
</ul>
<p><img src="http://oulmk4pq1.bkt.clouddn.com/pattern/pattern.jpg" alt=""></p>
<h1 id="1-创建型模式"><a href="#1-创建型模式" class="headerlink" title="1.  创建型模式"></a>1.  创建型模式</h1><h2 id="1-1-简单工厂Factory"><a href="#1-1-简单工厂Factory" class="headerlink" title="1.1.  简单工厂Factory"></a>1.1.  简单工厂Factory</h2><p>简单工厂模式<strong>不属于</strong>23种设计模式</p>
<h3 id="1-1-1-普通工厂"><a href="#1-1-1-普通工厂" class="headerlink" title="1.1.1.  普通工厂"></a>1.1.1.  普通工厂</h3><p>创建工厂类，一个创建对象的方法，根据参数类型不同，返回子类对象，如：邮件和短信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">factory.getProduct(int type)&#123;&#125;</div></pre></td></tr></table></figure>
<h3 id="1-1-2-多方法工厂"><a href="#1-1-2-多方法工厂" class="headerlink" title="1.1.2.  多方法工厂"></a>1.1.2.  多方法工厂</h3><p>不同方法返回不同子类对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">factory.getProductA()&#123;&#125;</div><div class="line">factory.getProductB()&#123;&#125;</div></pre></td></tr></table></figure>
<h3 id="1-1-3-静态工厂"><a href="#1-1-3-静态工厂" class="headerlink" title="1.1.3.  静态工厂"></a>1.1.3.  静态工厂</h3><p>方法是静态的，不需要实例工厂，最常用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Factory.getProduct(int type)&#123;&#125;</div><div class="line"></div><div class="line">Factory.getProduct()</div><div class="line"></div><div class="line">Factory.getProductA()&#123;&#125;</div><div class="line">Factory.getProductB()&#123;&#125;</div></pre></td></tr></table></figure>
<h2 id="1-2-工厂方法FactoryMethod"><a href="#1-2-工厂方法FactoryMethod" class="headerlink" title="1.2.  工厂方法FactoryMethod"></a>1.2.  工厂方法FactoryMethod</h2><p>简单工厂模式有一个问题就是，类的创建依赖工厂类，也就是说，如果想要拓展程序，必须对工厂类进行修改，这违背了闭包原则。</p>
<p>工厂方法模式，<strong>抽象出工厂接口</strong>，有多个工厂类实现（每个对象一个工厂，工厂实现同一接口）</p>
<h2 id="1-3-抽象工厂AbstractFactory"><a href="#1-3-抽象工厂AbstractFactory" class="headerlink" title="1.3.  抽象工厂AbstractFactory"></a>1.3.  抽象工厂AbstractFactory</h2><p>抽象工厂是应对<strong>产品族</strong>概念的。比如说，每个汽车公司可能要同时生产轿车，货车，客车，那么每一个工厂都要有创建轿车，货车和客车的方法。又比如每个工厂可能同时生成鼠标和键盘。</p>
<p>与工厂方法类似，不同的是每个工厂类可以生产不同类别的产品，如即可以生产鼠标也可以生成键盘。</p>
<p>与工厂方法的区别</p>
<ul>
<li>工厂方法只能生产一种产品类，抽象工厂方法能生产不同产品族的多个产品类(多个抽象产品类)</li>
<li>在只有一个产品族的情况下，抽象工厂模式实际上退化到工厂方法模式。</li>
</ul>
<h2 id="1-4-单例Singleton"><a href="#1-4-单例Singleton" class="headerlink" title="1.4.  单例Singleton"></a>1.4.  单例Singleton</h2><ul>
<li><p>私有静态实例；</p>
</li>
<li><p>私有构造方法；</p>
</li>
<li><p>synchronized getInstance()(每次调用都加锁，性能下降)，</p>
<ul>
<li><p>可以使用<strong>静态内部类</strong>getInstance(){new出对象}，静态内部类只有在使用的时候才装载类，可以看做是普通的静态类，和放在哪了没有关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;  </div><div class="line">    private static class SingletonHolder &#123;  </div><div class="line">        private static final Singleton INSTANCE = new Singleton();  </div><div class="line">    &#125;  </div><div class="line">    private Singleton ()&#123;&#125;  </div><div class="line">    public static final Singleton getInstance() &#123;  </div><div class="line">        return SingletonHolder.INSTANCE; </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>也可以使用双重判断，if(s==null){ synchronized(Class){ return new s}}，new s()不是原子性的，s需要volatile声明</p>
</li>
</ul>
</li>
<li><p>使用枚举创建单例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public emun Singleton &#123;  </div><div class="line">	INSTANCE;</div><div class="line">	private Singleton ()&#123;&#125;</div><div class="line">	public dosth()&#123;      </div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Singleton.INSTANCE.dosth()</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="1-5-建造者Builder"><a href="#1-5-建造者Builder" class="headerlink" title="1.5.  建造者Builder"></a>1.5.  建造者Builder</h2><p>创建复合对象，多部件制造和组装分开，构建与表示分离，同样的构建过程可以创建不同的表示，如：生成电脑包括生产CPU，显示器，内存，不同厂商生产出的不一样。</p>
<p>角色：</p>
<ul>
<li>建造者（包含建造各部件的方法）、</li>
<li>产品、</li>
<li>指挥者（<strong>指挥者类Director</strong>，其拥有一个建造者对象和建造PC产品的方法construct（组装产品），该方法通过具体建造者对象，依次执行每个步骤，最后返回建造完成的产品对象）</li>
</ul>
<p>样例：参数较多的类的构造(属于builder模式的变形)：如struts的ActionConfig </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Student&#123;</div><div class="line">	private Student(Student orig)&#123;</div><div class="line">  		this.name=orig.name</div><div class="line"> 	 	......</div><div class="line">	&#125;</div><div class="line">	public static class Builder &#123;</div><div class="line">        private Student target;</div><div class="line">        public Builder() &#123;</div><div class="line">            target = new Student();</div><div class="line">        &#125;</div><div class="line">         public Builder name(String name) &#123;</div><div class="line">            target.name = name;</div><div class="line">            return this;</div><div class="line">        &#125;</div><div class="line">        .......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tudent s=new Student.Builder().name(&quot;CC&quot;).age(11).address(xx);</div></pre></td></tr></table></figure>
<p>建造者模式与工厂模式区别</p>
<ul>
<li>建造者模式可以说是对工厂模式的扩展；</li>
<li>工厂类提供了生产<strong>单个</strong>产品的功能，而建造者模式则可以将<strong>各种</strong>产品集中起来进行统一管理；</li>
<li>工厂模式关注的是<strong>整个</strong>产品，建造者模式关注的是产品各组成<strong>部分</strong>的创建过程。</li>
</ul>
<p>建造者模式与模板模式区别</p>
<ul>
<li>建造者模式是<strong>创建型</strong>模式，模板模式是<strong>行为型</strong>模式；</li>
<li>建造者模式使用<strong>组合</strong>，模板模式使用<strong>继承</strong>；</li>
<li>建造者模式中的指挥者生产产品的方法construct类似模板模式的算法步骤。</li>
</ul>
<h2 id="1-6-原型Prototype"><a href="#1-6-原型Prototype" class="headerlink" title="1.6.  原型Prototype"></a>1.6.  原型Prototype</h2><p>分2种：</p>
<ul>
<li>普通原型模式：实现Cloneable接口及<strong>clone</strong>方法，</li>
<li>带原型管理器：除实现clone方法外，增加原型管理器角色，该角色保持一个<strong>聚集</strong>（如Map），作为对所有原型对象的登记，这个角色提供必要的方法，供外界增加新的原型对象和取得已经登记过的原型对象。</li>
</ul>
<p>如果需要创建的原型对象数目较少而且比较固定的话，可以采取普通原型模式，如果要创建的原型对象数目不固定的话，采用原型管理器</p>
<p>使用场景：当直接创建对象的代价比较大时，则采用这种模式。例如，一个对象需要在一个高代价的数据库操作之后被创建。</p>
<h1 id="2-结构型模式"><a href="#2-结构型模式" class="headerlink" title="2.  结构型模式"></a>2.  结构型模式</h1><h2 id="2-1-适配器Adapter"><a href="#2-1-适配器Adapter" class="headerlink" title="2.1.  适配器Adapter"></a>2.1.  适配器Adapter</h2><p>将一个类的接口转换成客户希望的另外一个接口。Adapter模式使得原本由于接口不<strong>兼容</strong>而不能一起工作的那些类可以在一起工作。</p>
<h3 id="2-1-1-类适配"><a href="#2-1-1-类适配" class="headerlink" title="2.1.1.  类适配"></a>2.1.1.  类适配</h3><p>继承旧类+实现新接口</p>
<h3 id="2-1-2-对象适配"><a href="#2-1-2-对象适配" class="headerlink" title="2.1.2.  对象适配"></a>2.1.2.  对象适配</h3><p>持有旧类+实现新接口 </p>
<h3 id="2-1-3-接口适配（缺省适配模式）"><a href="#2-1-3-接口适配（缺省适配模式）" class="headerlink" title="2.1.3.  接口适配（缺省适配模式）"></a>2.1.3.  接口适配（缺省适配模式）</h3><p><strong>适配器模式的用意</strong>是要改变源的接口，以便于目标接口相容。<strong>缺省适配的用意稍有不同</strong>，它是为了方便建立一个不平庸的适配器类而提供的一种平庸实现。</p>
<p>方法：创建抽象类实现接口所有方法（适配器类），然后继承抽象类，实现部分方法。</p>
<p>适用于当不希望实现一个接口中所有的方法，例如鲁智深是和尚，但只习武。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">interface 和尚&#123;吃斋，念佛，习武&#125;，</div><div class="line"></div><div class="line">Abstract 天星&#123;吃斋，念佛，习武&#125;，</div><div class="line"></div><div class="line">鲁智 extend 天星&#123;习武&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-装饰Decorator"><a href="#2-2-装饰Decorator" class="headerlink" title="2.2.  装饰Decorator"></a>2.2.  装饰Decorator</h2><p>实现<strong>同一接口</strong>,持有原对象的<strong>引用</strong>（通过传参的方式），调用原对象同名方法内前后<strong>增加功能</strong>。</p>
<p>例如：Spring 切面 在所有方法被调用时，记录日志。</p>
<h2 id="2-3-代理Proxy"><a href="#2-3-代理Proxy" class="headerlink" title="2.3.  代理Proxy"></a>2.3.  代理Proxy</h2><p>类似装饰模式，代理持有且<strong>实例化</strong>原对象（比如：在代理构造方法中new原对象）</p>
<p>代理模式的目的是：使用代理对象来<strong>控制</strong>对原有对象的访问</p>
<h2 id="2-4-外观Facade"><a href="#2-4-外观Facade" class="headerlink" title="2.4.  外观Facade"></a>2.4.  外观Facade</h2><p>外观模式<strong>不涉及接口</strong>，解决类与类之间依赖关系，将依赖关系放到一个<strong>外观类</strong>中，类似spring，将类之间的关系写在配置文件中，如：电脑启动（CPU 内存硬盘），电脑是外观类，持有并实例化其他类。</p>
<p>外观模式为系统提供一个<strong>统一的调用接口</strong>，使子系统更加容易使用。</p>
<h2 id="2-5-桥接Bridge"><a href="#2-5-桥接Bridge" class="headerlink" title="2.5.  桥接Bridge"></a>2.5.  桥接Bridge</h2><p>桥（多维的其中一维抽象）持有原始类的接口（另外一维）的引用，通过调用桥的方法，调用原始类，桥接模式可以使多维度中各维度变化分离，使用组合将多维度联系起来，如：车（轿车，公交车）、路（公路，高速公路）；同一个游戏中不同型号的对象，在不同平台（PC，手机）画面的展现。适用于<strong>多维组合解耦</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">AbstractRoad&#123; </div><div class="line">	Vehicle v  </div><div class="line">	run()&#123;</div><div class="line">		v.run()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">Highway extend AbstractRoad&#123;&#125;</div><div class="line">Freeway extend AbstractRoad&#123;&#125;</div><div class="line"></div><div class="line">interface Vehicle&#123; run()&#125;</div><div class="line">Car impl Vehicle&#123;run()&#125;</div><div class="line">Bus impl Vehicle&#123;run()&#125;</div></pre></td></tr></table></figure>
<p>与适配器模式区别：</p>
<ul>
<li>适配器模式：改变已有的两个接口，使相容。先有两边的东西，再有适配器</li>
<li>桥模式：分离抽象与实现，解决多维的变化问题。先有桥，再有两边的东西。</li>
</ul>
<h2 id="2-6-组合Composite"><a href="#2-6-组合Composite" class="headerlink" title="2.6.  组合Composite"></a>2.6.  组合Composite</h2><p>又称部分-整体模式，处理树形结构问题，将多个对象组合在一起进行操作，<strong>父子同类型</strong>，<strong>父持有子节点的集合</strong>。</p>
<p>使得用户对单个对象和组合对象的使用具有一致性（同一结构）</p>
<p>样例：文件系统：文件+目录</p>
<h2 id="2-7-享元Flyweight"><a href="#2-7-享元Flyweight" class="headerlink" title="2.7.  享元Flyweight"></a>2.7.  享元Flyweight</h2><p>实现对象的共享，即共享池，实现面向大量对象请求时，对象复用，如：数据库连接池，可以减少内存的开销，通常与工厂模式一起使用，池持有对象的数组，当一个客户端请求时，工厂需要检查当前对象池中是否有符合条件的对象。</p>
<ul>
<li>享元对象包含共享的内部状态，又可以通过方法传参的方式传入外部状态。</li>
<li><strong>享元工厂</strong>负责创建和管理享元对象，持有享元的集合</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ChessFlyWeight&#123;</div><div class="line">	String Color;//共享的内部状态,</div><div class="line">	FlyweightImpl(String Color)&#123;      </div><div class="line">	&#125;</div><div class="line">	display(Coordinate c)&#123;//传入外部状态</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用享元模式的条件： </p>
<ol>
<li>系统中有大量的对象，他们使系统的效率降低。 </li>
<li>这些对象的状态可以分离出所需要的内外两部分。</li>
</ol>
<p>例子：String类的设计就是享元模式，当两个String 对象所包含的内容相同的时候，JVM 只创建一个String 对象对应这两个不同的对象引用。</p>
<p>围棋的棋子，颜色一样，位置不一样，位置为外部对象Coordinate</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">ChessFlyWeight&#123;</div><div class="line">	String Color;//共享的内部状态,</div><div class="line">	FlyweightImpl(String Color)&#123;      </div><div class="line">	&#125;</div><div class="line">	display(Coordinate c)&#123;//传入外部状态</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">public class Coordinate &#123;</div><div class="line">    private int x,y;</div><div class="line">&#125;</div><div class="line">public static void main(String[] args) &#123;</div><div class="line">        ChessFlyWeight chess1=ChessFlyWeightFactory.getChess(&quot;黑色&quot;);</div><div class="line">        ChessFlyWeight chess2=ChessFlyWeightFactory.getChess(&quot;黑色&quot;);</div><div class="line">        System.out.println(chess1);</div><div class="line">        System.out.println(chess2);</div><div class="line">        chess1.display(new Coordinate(10,10));</div><div class="line">        chess2.display(new Coordinate(20,20));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-行为型模式"><a href="#3-行为型模式" class="headerlink" title="3.  行为型模式"></a>3.  行为型模式</h1><h2 id="3-1-父与子"><a href="#3-1-父与子" class="headerlink" title="3.1.  父与子"></a>3.1.  父与子</h2><h3 id="3-1-1-策略Strategy-表驱动模式"><a href="#3-1-1-策略Strategy-表驱动模式" class="headerlink" title="3.1.1.  策略Strategy(表驱动模式)"></a>3.1.1.  策略Strategy(表驱动模式)</h3><p>多用在算法决策系统，对算法封装，<strong>用户决定使用哪种算法</strong>，如：加减乘除实现同一接口、复杂的if else分支，可以把各种情况定义为字典-实现的映射，根据输入的字典，决定使用哪种算法。</p>
<p>context:环境角色持有一个策略的引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Content&#123;</div><div class="line">  Strategy stgy;</div><div class="line">  Content(Strategy stgy)&#123;</div><div class="line">    this.stgy=stgy;</div><div class="line">  &#125;</div><div class="line">  todo()&#123;</div><div class="line">    stgy.todo();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-1-2-模板方法Template-methed"><a href="#3-1-2-模板方法Template-methed" class="headerlink" title="3.1.2.  模板方法Template methed"></a>3.1.2.  模板方法Template methed</h3><p><strong>抽象类**</strong>定义算法结构**，子类实现算法步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">AbstractClass&#123;</div><div class="line">  abstract step1();</div><div class="line">  abstract step2();</div><div class="line">  abstract step3();</div><div class="line">  templateMethed()&#123;</div><div class="line">   step1();</div><div class="line">   step2();</div><div class="line">   step3(); </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-两类之间"><a href="#3-2-两类之间" class="headerlink" title="3.2.  两类之间"></a>3.2.  两类之间</h2><h3 id="3-2-1-观察者Observer"><a href="#3-2-1-观察者Observer" class="headerlink" title="3.2.1.  观察者Observer"></a>3.2.1.  观察者Observer</h3><p>被观察者持有观察者<strong>集合</strong>，提供register，delete，notify（当对象变化时，可以遍历集合，调用观察者的方法）</p>
<h3 id="3-2-2-迭代器Iterator"><a href="#3-2-2-迭代器Iterator" class="headerlink" title="3.2.2.  迭代器Iterator"></a>3.2.2.  迭代器Iterator</h3><p>迭代器模式是与集合<strong>共生共死</strong>的，迭代器对集合对象进行遍历操作，迭代器持有集合对象,集合对象提供返回迭代器的方法（return new 迭代器(this集合对象)），或迭代器是集合的内部成员类，可以直接访问集合对象数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">interface Iterator &#123;</div><div class="line">     public boolean hasNext();</div><div class="line">     public Object next();</div><div class="line">&#125;</div><div class="line"></div><div class="line">ConcreteIterator implements Iterator &#123;</div><div class="line">     private List list = null;</div><div class="line">     private int index; </div><div class="line">     public ConcreteIterator(List list) &#123;//持有集合对象</div><div class="line">         super();</div><div class="line">         this.list = list;</div><div class="line">     &#125;</div><div class="line">      public boolean hasNext()&#123;</div><div class="line">      	return index &lt; list.getSize()</div><div class="line">      &#125;</div><div class="line">     public Object next()&#123;</div><div class="line">       		Object object = list.get(index);</div><div class="line">         index++;</div><div class="line">         return object;</div><div class="line">     &#125;</div><div class="line">&#125; </div><div class="line"></div><div class="line"> ArrayList impl List &#123;</div><div class="line">      public void add(Object obj);  </div><div class="line">      public Object get(int index);</div><div class="line">      public Iterator iterator()&#123;//返回迭代器</div><div class="line">      		return new ConcreteIterator(this);</div><div class="line">      &#125; </div><div class="line">      public int getSize();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>样例：java Collection 返回Iterator 方法Iterator()</p>
<h3 id="3-2-3-责任链Chain-of-responsibility"><a href="#3-2-3-责任链Chain-of-responsibility" class="headerlink" title="3.2.3.  责任链Chain of responsibility"></a>3.2.3.  责任链Chain of responsibility</h3><p>使多个对象都有机会处理请求，从而避免请求的发送者和接受者之间的耦合关系。<strong>处理者持有下一处理者的引用</strong>形成链，请求在这个链上传递，直到某一对象决定处理该请求。但是发出者并不清楚到底最终那个对象会处理该请求，责任链模式可以实现，在隐瞒客户端的情况下，对系统进行动态的调整。</p>
<ul>
<li>链表中每一个对象都可能而且可以成为入口，而不是必须从链头开始。</li>
<li>如果是if else的分支，通常使用策略模式（表驱动模式）</li>
<li>如果处理者有上下级关系时，可以考虑使用责任链，如：打牌出牌，流程审批，java异常机制catch顺序，Struts2连接器，tomcat的Filter</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Handler&#123;</div><div class="line">  Handler nextHandler //持有下一处理者的引用</div><div class="line">  handleRequest()&#123;</div><div class="line">  	//todo or not todo something</div><div class="line">    nextHandler.handleRequest();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-4-命令Command"><a href="#3-2-4-命令Command" class="headerlink" title="3.2.4.  命令Command"></a>3.2.4.  命令Command</h3><p>将一个请求封装成一个对象，实现对命令请求者（Invoker）和命令实现者（Receiver）的<strong>解耦</strong>。</p>
<p><strong>调用者-&gt;命令-&gt;执行者</strong>，调用者持有命令的引用，调用命令执行方法，命令持有执行者的引用，命令执行方法调用执行者的执行方法，例如：司令–&gt;命令–&gt;兵</p>
<p> 使用场景：</p>
<ul>
<li>需要记录命令的日志</li>
<li>请求者和实现者解耦，不交互</li>
</ul>
<h2 id="3-3-类状态"><a href="#3-3-类状态" class="headerlink" title="3.3.  类状态"></a>3.3.  类状态</h2><h3 id="3-3-1-备忘录Memento"><a href="#3-3-1-备忘录Memento" class="headerlink" title="3.3.1.  备忘录Memento"></a>3.3.1.  备忘录Memento</h3><p>用于备份恢复对象原先的状态，<strong>对象有创建备忘录，恢复备忘录的方法</strong>，备忘录包含需记录的对象的属性（多属性用Map） ，<strong>备忘录管理类</strong>持有备忘录的引用（多备忘录用MAP），提供和保存备忘录，样例：JDBC事务回滚，Ctrl+Z</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Object&#123;</div><div class="line">state</div><div class="line">createMemento()&#123;</div><div class="line"> 		return new Memento(this.state);  </div><div class="line">	&#125;</div><div class="line">restoreMemento(Memento memento)&#123;</div><div class="line"> 		this.state=memento.getState();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Memento &#123;  </div><div class="line">    private String state = &quot;&quot;;  </div><div class="line">    public Memento(String state)&#123;  </div><div class="line">        this.state = state;  </div><div class="line">    &#125;  </div><div class="line">    public String getState() &#123;  </div><div class="line">        return state;  </div><div class="line">    &#125;  </div><div class="line">    public void setState(String state) &#123;  </div><div class="line">        this.state = state;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line">MemoMgr&#123;</div><div class="line">    private Memento memento;  </div><div class="line">    public Memento getMemento()&#123;  </div><div class="line">        return memento;  </div><div class="line">    &#125;  </div><div class="line">    public void setMemento(Memento memento)&#123;  </div><div class="line">        this.memento = memento;  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-2-状态State"><a href="#3-3-2-状态State" class="headerlink" title="3.3.2.  状态State"></a>3.3.2.  状态State</h3><p>当一个对象有多个状态切换时，可以把状态抽象成类，不同状态执行不同操作，IF ELSE</p>
<ul>
<li>状态类：状态名+<strong>行为</strong>，</li>
<li>环境类：定义客户感兴趣的接口。维护一个State子类的实例，这个实例定义当前状态。</li>
</ul>
<p>环境类和状态类之间存在一种<strong>双向关联</strong>关系，</p>
<p>谁定义状态转换？</p>
<ol>
<li>如果下一个状态跟当前状态有关，各个具体的状态类对象负责状态的转换，</li>
<li>如果下一个状态跟当前状态无关，就可以选择由上下文来决定状态转换</li>
</ol>
<p>例子：门开关状态，酒店房间状态</p>
<p>与策略模式区别：</p>
<ul>
<li>策略封装多个平行的多变的实现方式</li>
<li>状态封装内部变化，以外部行为表现出来</li>
</ul>
<h2 id="3-4-中间类"><a href="#3-4-中间类" class="headerlink" title="3.4.  中间类"></a>3.4.  中间类</h2><h3 id="3-4-1-访问者Visitor"><a href="#3-4-1-访问者Visitor" class="headerlink" title="3.4.1.  访问者Visitor"></a>3.4.1.  访问者Visitor</h3><p>可以在不改变对象结构的情况下给对象增加新的操作（即访问者的方法）。被访问的元素有accept方法，以访问者为参数，调用访问者的访问方法，访问者的访问方法以被访问对象为参数，<strong>双重分派</strong>（一个方法根据两个宗量（方法接收者和入参）的类型来决定执行不同的代码）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Element：accept(Visitor v)&#123;  </div><div class="line">	v.visit(this);  </div><div class="line">&#125;</div><div class="line"></div><div class="line">Visitor: visit(Elemente)&#123;</div><div class="line">	dosth  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即在不改变Element的情况下，为Element增加了dosth的操作。</p>
<p><strong>接收访问者的同时，调用访问者访问方法</strong>：accept-&gt;visit</p>
<h3 id="3-4-2-中介者Mediator"><a href="#3-4-2-中介者Mediator" class="headerlink" title="3.4.2.  中介者Mediator"></a>3.4.2.  中介者Mediator</h3><p>用于多个类之间相互交互，网状变星状，中介者使各个对象不需要显示地相互引用，从而使其耦合性松散，而且可以独立地改变他们之间的交互。</p>
<ul>
<li>中介持有所有对象的引用；</li>
<li>对象持有中介的引用；</li>
<li>中介用来封装<strong>行为</strong>。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Mediator&#123; </div><div class="line">	ColleagueA a;</div><div class="line">	ColleagueBb;</div><div class="line">	AaffectB();</div><div class="line">	BaffectA();</div><div class="line">&#125;</div><div class="line"></div><div class="line">ColleagueA</div><div class="line">	Mediator m</div><div class="line">	dosth()&#123;</div><div class="line">		m. AaffectB();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>缺点：中介类易变上帝类</p>
<p>与Façade区别</p>
<ul>
<li>Façade为一组内聚的对象，<strong>提供一个统一的外部接口</strong>，</li>
<li>Mediator为在一组互相协作的对象内部起<strong>协调</strong>作用。</li>
</ul>
<p>样例：QQ群</p>
<h3 id="3-4-3-解释器Interpreter"><a href="#3-4-3-解释器Interpreter" class="headerlink" title="3.4.3.  解释器Interpreter"></a>3.4.3.  解释器Interpreter</h3><p>对算法进行最小化拆分，用于编译器开发，解释器模式根据问题将算法和参与运算的值组合成一个树型结构，非叶子节点（NonterminalExpression）为算法，叶子节点（TerminalExpression）为参与运算的值，最后通过遍历这颗树求得问题的解。</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>method factory：interface+multiple factory</p>
<p>Abstract factory：multiple method create multiple product</p>
<p>builder：build part，director { builder b, construct(){ b.A(); b.B(); b.C(); }  }</p>
<p>singleton：private instance and constructor</p>
<p>prototype：clone / clone+collection </p>
<p>adapter：extend / hold reference</p>
<p>decorator：hold reference</p>
<p>proxy：new instance</p>
<p>facade：new all instance</p>
<p>bridge：multi-dimension decoupling，one dimension hold another’s reference</p>
<p>composite：one structure，parent  can get child</p>
<p>flyweight：factory（create、get） + collection</p>
<p>strategy：strategy interface + context chose one  strategy reference</p>
<p>template method：abstract class contain abstract step method，define structure of step sequence</p>
<p>observer：subject hold collection of reference of observer，register，delete，notify(call observer‘s method)</p>
<p>iterator：collection.iterator(this)，iterator hold reference of collection </p>
<p>chain of responsibility：handler–&gt;next handler</p>
<p>command：invoker.do–&gt;command.do–&gt; receiver.do()</p>
<p>memento：create + restore，mementoMgr–&gt;memento</p>
<p>state：state effect handler，context-&gt;state</p>
<p>visitor：Subject.accept(visitor){ visitor.visit(this) }</p>
<p>mediator：encapsulate how a set of objects interact   A&lt;–&gt;mediator&lt;–&gt;B</p>
<p>interpret：TerminalExpress，NonTerminalExpress</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/08/java-GC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/java-GC/" itemprop="url">java-GC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T10:23:46+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jdk/" itemprop="url" rel="index">
                    <span itemprop="name">jdk</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/08/java-GC/" class="leancloud_visitors" data-flag-title="java-GC">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何判断是否可以回收"><a href="#如何判断是否可以回收" class="headerlink" title="如何判断是否可以回收"></a>如何判断是否可以回收</h1><ol>
<li><p>引用计数，相互引用，无法释放</p>
</li>
<li><p>可达性算法，从GC Root向下搜索引用链，不在链上的可以回收，实际是找链上的存活对象，其他的可回收</p>
<p>可作为gc root的对象：<br>（1）<strong>栈</strong>中局部变量的引用对象<br>（2）<strong>方法区</strong>类<strong>静态</strong>属性的引用对象<br>（3）<strong>方法区常量</strong>引用对象<br>（4）本地方法<strong>栈</strong>中引用对象</p>
</li>
</ol>
<h1 id="回收算法"><a href="#回收算法" class="headerlink" title="回收算法"></a>回收算法</h1><ol>
<li><p>标记清除：老年代，效率不高，空间碎片；</p>
<p><strong>CMS</strong></p>
</li>
<li><p>复制算法：新生代Eden，Survivor from ,Survivor to,在对象存活率高的情况下，效率低</p>
<p><strong>Serial，Parallel New，Parallel Scavenge</strong></p>
</li>
<li><p>标记整理：老年代，存活对象移向一端；</p>
<p><strong>Serail Old，Parallel Old，G1</strong></p>
</li>
<li><p>分代收集：新生代，老年代，永久代(java类，方法，使用动态代理生产class，jdk8移除，改为native Memory)，</p>
<ul>
<li>新生代Eden满-&gt;minorGC</li>
<li>老年代满-&gt;FullGC</li>
</ul>
</li>
</ol>
<h1 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h1><ol>
<li><p>新生代:</p>
<p>{0}. Serial（单线程）、<br>{0}. Parallel New（多线程）、<br>{0}. Parallel Scavenge（吞吐优先，吞吐量=用户CPU时长/（用户CPU时长+GC时长））<br>{0}. G1：Garbage First 第一时间处理垃圾最多的区域，1.7出现，计划替代cms</p>
<ul>
<li>新老代都回收，作用于Java堆</li>
<li>可设置停顿比例，可预测停顿</li>
<li>堆被划分成 许多个连续的区域(region)，并行</li>
<li>并发</li>
<li>G1划分了一个Humongous区，它用来专门存放巨型对象。如果一个H区装不下一个巨型对象，那么G1会寻找连续的H分区来存储。为了能找到连续的H区，有时候不得不启动Full GC。</li>
</ul>
</li>
<li><p>老年代:</p>
<p>{0}. Serial Old（单线程）、<br>{0}. Parallel Old（吞吐优先）、<br>{0}. CMS（时间优先，最短回收停顿，并发）<br>   {0}. 回收过程：初始标记-&gt;并发标记-&gt;再次标记-&gt;并发清除<br>   {0}. 只有Serial/Parallel New可以配合CMS使用<br>   {0}. 有碎片<br>{0}. G1</p>
</li>
</ol>
<h2 id="串行-并行-并发"><a href="#串行-并行-并发" class="headerlink" title="串行/并行/并发"></a>串行/并行/并发</h2><ul>
<li><p>串行：gc单线程</p>
<p>​    Serial、Serial old</p>
</li>
<li><p>并行：gc多线程</p>
<p>​    除Serial、Serial old外都是并行</p>
</li>
<li><p>并发：多cpu时，用户线程和gc线程同时执行，</p>
<p>​    cms、G1</p>
</li>
</ul>
<h2 id="垃圾收集器组合"><a href="#垃圾收集器组合" class="headerlink" title="垃圾收集器组合"></a>垃圾收集器组合</h2><p><img src="http://oulmk4pq1.bkt.clouddn.com/java/gc组合.png" alt=""></p>
<p>Hotspot JVM实现中几种GC算法组合包含：</p>
<ul>
<li>Serial GC算法：Serial+Serial Old</li>
<li>Parallel GC算法：Parallel New+串行PS MarkSweep GC(实际是Serail Old的壳)/并行Parallel Old，选PS MarkSweep GC 还是 Parallel Old GC 由参数UseParallelOldGC来控制；</li>
<li>CMS GC算法：Parallel New+CMS+ Full GC for CMS算法（应对核心的CMS GC某些时候的不赶趟，开销很大）；</li>
<li>G1 GC算法：Young GC + mixed GC（新生代，再加上部分老生代）＋ Full GC for G1 GC算法（应对G1 GC算法某些时候的不赶趟，开销很大）</li>
</ul>
<h2 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h2><ul>
<li>young GC（minorGC）：Eden满了</li>
<li>Serial Old GC／PS MarkSweep GC／Parallel Old GC的触发则是：在要执行Young GC时候预测其promote的object的总size超过老生代剩余size；</li>
<li>CMS GC的initial marking的触发条件是老生代使用比率超过某值；</li>
<li>G1 GC的initial marking的触发条件是Heap使用比率超过某值，跟CMS GC触发条件类似；</li>
<li>Full GC for CMS算法和Full GC for G1 GC算法的触发原因很明显，就是CMS GC和G1 GC的算法不赶趟了，只能全局范围大搞一次GC了（这很慢）；</li>
</ul>
<h2 id="jdk默认垃圾收集器（不确定是否对）"><a href="#jdk默认垃圾收集器（不确定是否对）" class="headerlink" title="jdk默认垃圾收集器（不确定是否对）"></a>jdk默认垃圾收集器（不确定是否对）</h2><ul>
<li>1.6：ParNew+Serail Old/Parallel Old(需设置参数指定)</li>
<li>1.7-1.8：Parallel Scavenge+Parallel Old</li>
<li>1.9：G1</li>
</ul>
<h1 id="对象内存分配过程"><a href="#对象内存分配过程" class="headerlink" title="对象内存分配过程"></a>对象内存分配过程</h1><h2 id="新生代内存分配"><a href="#新生代内存分配" class="headerlink" title="新生代内存分配"></a>新生代内存分配</h2><ol>
<li><p>优先分配到线程本地缓冲区TLAB(Thread Local Allocation Buffer)，TLAB属于Eden一部分；</p>
</li>
<li><p>如果TLAB不能分配，在Eden分配：释放Eden不活跃对象，仍空间不足时，触发MinorGC；空间分配担保：MinorGC之前，会评估老年代的连续空间是否大于新生代对象总大小或者历次晋升的平均大小，是的话就会进行Minor GC，否则将进行Full GC。</p>
<p>MinorGC过程：</p>
<p>{0}. Eden-&gt;To：存活对象<br>{0}. From-&gt;To：存活对象<br>{0}. From-&gt;Old：长存活对象：15次<br>{0}. To-&gt;Old：Minor GC时，当Survivor To放不下时，进入老年代</p>
</li>
</ol>
<h2 id="OldGen内存分配"><a href="#OldGen内存分配" class="headerlink" title="OldGen内存分配"></a>OldGen内存分配</h2><ol>
<li>大对象直接进老年代：长字符串及数组</li>
<li>长期存活对象进老年代，15次</li>
<li>空间分配担保：Minor GC时，当Survivor To放不下时，进入老年代</li>
<li>动态年龄判断，不是所有都需要15次，同一age对象大小&gt;50%Survivor，&gt;age的对象进入老年代</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p>当内存空间还足够时，则能保留在内存之中；如果内存在进行垃圾收集后还是非常紧张，则可以抛弃这些对象，Java对引用的概念进行了扩充，将引用分为四种，这四种引用强度依次逐渐减弱。</p>
<ol>
<li>强引用（Strong Reference）：</li>
<li>软引用（Soft Reference）：溢出前回收</li>
<li>弱引用（Weak Reference）：gc时回收</li>
<li>虚引用（Phantom Reference）：为一个对象设置虚引用关联的唯一目的就是希望能在这个对象被收集器回收时收到一个系统通知</li>
</ol>
<h1 id="方法区的回收"><a href="#方法区的回收" class="headerlink" title="方法区的回收"></a>方法区的回收</h1><ul>
<li>常量池回收：无引用</li>
<li>类型卸载：实例已回收，且加载该类的classLoader已回收，无任何引用</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/08/Quartz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/08/Quartz/" itemprop="url">Quartz</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-08T10:04:16+08:00">
                2018-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3rd-party-jars/" itemprop="url" rel="index">
                    <span itemprop="name">3rd party jars</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/08/Quartz/" class="leancloud_visitors" data-flag-title="Quartz">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz1.png" alt=""></p>
<p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz2.png" alt=""></p>
<h2 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h2><p>是一个接口，只有一个方法void execute(JobExecutionContext context)，开发者实现该接口定义运行任务，JobExecutionContext类提供了调度上下文的各种信息。Job运行时的信息保存在JobDataMap实例中；</p>
<h3 id="Job并发"><a href="#Job并发" class="headerlink" title="Job并发"></a>Job并发</h3><p>Job是有可能并发执行的，比如一个任务要执行10秒中，而调度算法是每秒中触发1次，那么就有可能多个任务被并发执行。</p>
<p>有时候我们并不想任务并发执行，比如这个任务要去&quot;获得数据库中所有未发送邮件的名单&quot;，如果是并发执行，就需要一个数据库锁去避免一个数据被多次处理。这个时候一个@DisallowConcurrentExecution解决这个问题。</p>
<p>就是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class DoNothingJob implements Job &#123;</div><div class="line"></div><div class="line">    @DisallowConcurrentExecution</div><div class="line">    public void execute ( JobExecutionContext context ) throws JobExecutionException &#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，@<strong>DisallowConcurrentExecution</strong>是对JobDetail实例生效，也就是如果你定义两个JobDetail，引用同一个Job类，是可以并发执行的。</p>
<p><strong>@PersistJobDataAfterExecution</strong> ：此注解表示当这个Job的execute方法执行成功后，更新并存储它所持有的JobDetail属性中JobDataMap。如果使用这个注解，强烈建议也使用@DisallowConcurrentExecution，因为并发执行过程中，JobDataMap有可能会发生冲突</p>
<h2 id="JobDetail"><a href="#JobDetail" class="headerlink" title="JobDetail"></a>JobDetail</h2><p>​    Quartz在每次执行Job时，都重新创建一个Job实例，所以它不直接接受一个Job的实例，相反它接收一个Job实现类，以便运行时通过newInstance()的反射机制实例化Job。因此需要通过一个类来描述Job的实现类及其它相关的静态信息，如Job名字、描述、关联监听器等信息，JobDetail承担了这一角色。jobDetail.getJobDataMap().put()可以传递参数给Job。</p>
<p>JobDetail有两个boolean属性：</p>
<ul>
<li>isDurable：如果设为false，则对应的Job一旦没有关联的触发器，就会被Scheduler自动删除。</li>
<li>requestsRecovery：如果设为true，当Job执行中遇到硬中断（例如运行崩溃、机器断电等），Scheduler会重新执行。这种情况下，JobExecutionContext.isRecovering()会返回ture。</li>
</ul>
<h2 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h2><p>是一个类，描述触发Job执行的时间触发规则。主要有SimpleTrigger和CronTrigger这两个子类。</p>
<h3 id="SimpleTrigger"><a href="#SimpleTrigger" class="headerlink" title="SimpleTrigger"></a>SimpleTrigger</h3><p>当仅需触发一次或者以固定时间间隔周期执行，SimpleTrigger是最适合的选择；</p>
<h3 id="CronTrigger"><a href="#CronTrigger" class="headerlink" title="CronTrigger"></a>CronTrigger</h3><p>CronTrigger则可以通过Cron表达式定义出各种复杂时间规则的调度方案：如每早晨9:00执行，周一、周三、周五下午5:00执行等；</p>
<h3 id="CalendarIntervalTrigger"><a href="#CalendarIntervalTrigger" class="headerlink" title="CalendarIntervalTrigger"></a>CalendarIntervalTrigger</h3><p>类似于SimpleTrigger，指定从某一个时间开始，以一定的时间间隔执行的任务。 但是不同的是SimpleTrigger指定的时间间隔为毫秒，没办法指定每隔一个月执行一次（每月的时间间隔不是固定值），而CalendarIntervalTrigger支持的间隔单位有秒，分钟，小时，天，月，年，星期。</p>
<p>相较于SimpleTrigger有两个优势：</p>
<ol>
<li>更方便，比如每隔1小时执行，你不用自己去计算1小时等于多少毫秒。</li>
<li>支持不是固定长度的间隔，比如间隔为月和年。但劣势是精度只能到秒。</li>
</ol>
<p>它适合的任务类似于：9:00 开始执行，并且以后每周 9:00 执行一次</p>
<p>它的属性有:</p>
<ul>
<li>interval 执行间隔</li>
<li>intervalUnit 执行间隔的单位（秒，分钟，小时，天，月，年，星期）</li>
</ul>
<h3 id="DailyTimeIntervalTrigger"><a href="#DailyTimeIntervalTrigger" class="headerlink" title="DailyTimeIntervalTrigger"></a>DailyTimeIntervalTrigger</h3><p>指定每天的某个时间段内，以一定的时间间隔执行任务。并且它可以支持指定星期。</p>
<p>它适合的任务类似于：指定每天9:00 至 18:00 ，每隔70秒执行一次，并且只要周一至周五执行。</p>
<p>它的属性有:</p>
<ul>
<li>startTimeOfDay 每天开始时间</li>
<li>endTimeOfDay 每天结束时间</li>
<li>daysOfWeek 需要执行的星期</li>
<li>interval 执行间隔</li>
<li>intervalUnit 执行间隔的单位（秒，分钟，小时，天，月，年，星期）</li>
<li>repeatCount 重复次数</li>
</ul>
<p>TriggerUtils ：创建Trigger的工具类</p>
<h2 id="Calendar"><a href="#Calendar" class="headerlink" title="Calendar"></a>Calendar</h2><p>​    org.quartz.Calendar和java.util.Calendar不同，它是一些日历特定时间点的集合（可以简单地将org.quartz.Calendar看作java.util.Calendar的集合——java.util.Calendar代表一个日历时间点，无特殊说明后面的Calendar即指org.quartz.Calendar）。<strong>一个Trigger可以和多个Calendar关联</strong>，以便排除或包含某些时间点。假设，我们安排每周星期一早上10:00执行任务，但是如果碰到法定的节日，任务则不执行，这时就需要在Trigger触发机制的基础上使用Calendar进行定点排除。</p>
<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><p>​    代表一个Quartz的独立运行容器，Trigger和JobDetail可以注册到Scheduler中，两者在Scheduler中拥有各自的组及名称，组及名称是Scheduler查找定位容器中某一对象的依据，Trigger的组及名称必须唯一，JobDetail的组和名称也必须唯一（但可以和Trigger的组和名称相同，因为它们是不同类型的）。Scheduler定义了多个接口方法，允许外部通过组及名称访问和控制容器中Trigger和JobDetail。</p>
<p>​    Scheduler就是Quartz的大脑，所有任务都是由它来设施。Schduelr包含一个两个重要组件: JobStore和ThreadPool。</p>
<h3 id="JobStore"><a href="#JobStore" class="headerlink" title="JobStore"></a>JobStore</h3><p>是用来存储运行时信息的，包括Trigger,Schduler,JobDetail，业务锁等。它有多种实现</p>
<ul>
<li>RAMJob(内存实现)，</li>
<li>JobStoreTX(JDBC，事务由Quartz管理），</li>
<li>JobStoreCMT(JDBC，使用容器事务)，</li>
<li>ClusteredJobStore(集群实现)、</li>
<li>TerracottaJobStore。</li>
</ul>
<h3 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h3><p>​    就是线程池，Scheduler使用一个线程池作为任务运行的基础设施，任务通过共享线程池中的线程提高运行效率。Quartz有自己的线程池实现。所有任务的都会由线程池执行。Scheduler 调度线程主要有两个： 执行常规调度的线程，和执行 misfired trigger 的线程。常规调度线程轮询存储的所有 trigger，如果有需要触发的 trigger，即到达了下一次触发的时间，则从任务执行线程池获取一个空闲线程，执行与该 trigger 关联的任务。Misfire 线程是扫描所有的 trigger，查看是否有 misfired trigger，如果有的话根据 misfire 的策略分别处理。下图描述了这两个线程的基本流程</p>
<p>图4</p>
<p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz4.png" alt=""></p>
<p>图5</p>
<p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz5.png" alt="">                  </p>
<p>​    Scheduler可以将Trigger绑定到某一JobDetail中，这样当Trigger触发时，对应的Job就被执行。一个Job可以对应多个Trigger，但一个Trigger只能对应一个Job。可以通过SchedulerFactory创建一个Scheduler实例。Scheduler拥有一个SchedulerContext，它类似于ServletContext，保存着Scheduler上下文信息，Job和Trigger都可以访问SchedulerContext内的信息。SchedulerContext内部通过一个Map，以键值对的方式维护这些上下文数据，SchedulerContext为保存和获取数据提供了多个put()和getXxx()的方法。可以通过Scheduler# getContext()获取对应的SchedulerContext实例。</p>
<h1 id="开发步骤"><a href="#开发步骤" class="headerlink" title="开发步骤"></a>开发步骤</h1><h2 id="标准开发步骤"><a href="#标准开发步骤" class="headerlink" title="标准开发步骤"></a>标准开发步骤</h2><ol>
<li><p>开发job，实现Job接口</p>
</li>
<li><p>new JobDetail</p>
<p>JobDetail jobDetail = <strong>new</strong> JobDetail(jobName, _JOB_GROUP_NAME_, cls);</p>
</li>
<li><p>传递/获得参数</p>
<ul>
<li>传递参数:jobDetail.getJobDataMap().put()</li>
<li>获得参数content.getJobDetail().getJobDataMap()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class QuartzJob implements Job &#123;</div><div class="line">    @Override</div><div class="line">    public void execute(JobExecutionContext content) throws JobExecutionException &#123;</div><div class="line">        System.out.println(new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date())+ &quot;★★★★★★★★★★★&quot;);</div><div class="line">        String jobName = content.getJobDetail().getName();</div><div class="line">        JobDataMap dataMap = content.getJobDetail().getJobDataMap();</div><div class="line">        String param = dataMap.getString(&quot;param&quot;);</div><div class="line">        System.out.println(&quot;传递的参数是=&quot;+param +&quot;任务名字是=&quot;+jobName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>new Trigger,指定周期</p>
</li>
<li><p>实例化Scheduler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SchedulerFactory_gSchedulerFactory_ = new StdSchedulerFactory();</div><div class="line">Scheduler sched = gSchedulerFactory.getScheduler();</div></pre></td></tr></table></figure>
</li>
<li><p>加入schedule容器</p>
<p>sched.scheduleJob(jobDetail, trigger);</p>
</li>
<li><p>启动schedule</p>
<p>sched.start();</p>
</li>
</ol>
<h2 id="spring-quartz集成"><a href="#spring-quartz集成" class="headerlink" title="spring+quartz集成"></a>spring+quartz集成</h2><p>配置以下bean：</p>
<ul>
<li>Job bean,不用实现Job类</li>
<li>MethodInvokingJobDetailFactoryBean</li>
<li>CronTriggerBean or SimpleTriggerBean</li>
<li>SchedulerFactoryBean</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li><p>JobDetail负责Job的实例化，可传参给Job</p>
</li>
<li><p>Scheduler类似容器，Trigger和JobDetail注册在其中，可以根据名字和组获得Trigger和JobDetail</p>
</li>
<li><p>Job实现类通过JobExecutionContext可以获得JobDetail里的参数</p>
</li>
<li><p>SimpleTrigger 必须设置repeatCount，否则只执行一次</p>
</li>
<li><p>除SimpleTrigger和CronTrigger外的Trigger：</p>
<p>CalendarIntervalTrigger：每隔XX秒，分钟，小时，天，月，年，星期执行一次</p>
<p>DailyTimeIntervalTrigger: 每天9:00 至 18:00 ，每隔70秒执行一次，并且只要周一至周五执行</p>
</li>
</ol>
<h2 id="Crontab通配符"><a href="#Crontab通配符" class="headerlink" title="Crontab通配符"></a>Crontab通配符</h2><p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz6.png" alt=""></p>
<p><strong>通配符*</strong>：表示所有值。例如:在分的字段上设置 “*“,表示每一分钟都会触发<br><strong>通配符?</strong>：表示不指定值。使用的场景为不需要关心当前设置这个字段的值。例如:要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为”?” 具体设置为 0 0 0 10 <em> ?<br><strong>通配符-</strong>：表示区间。例如在小时上设置 “10-12”,表示 10,11,12点都会触发。<br><strong>通配符,</strong>：表示指定多个值。例如在周字段上设置 “MON,WED,FRI” 表示周一，周三和周五触发<br><strong>通配符/</strong>：用于递增触发。如在秒上面设置”5/15” 表示从5秒开始，每增15秒触发(5,20,35,50)。在月字段上设置’1/3’所示每月1号开始，每隔三天触发一次。<br><strong>通配符L</strong>：表示最后的意思。例如在日字段设置上，表示当月的最后一天(依据当前月份，如果是二月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于”7”或”SAT”。如果在”L”前加上数字，则表示该数据的最后一个。例如在周字段上设置”6L”这样的格式，则表示“本月最后一个星期五”<br><strong>通配符W</strong>：表示离指定日期的最近那个工作日(周一至周五)。例如在日字段上设置”15W”，表示离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)触发, 如果15号是周未，则找最近的下周一(16号)触发。如果15号正好在工作日(周一至周五)，则就在该天触发。如果指定格式为 “1W”,它则表示每月1号往后最近的工作日触发。如果1号正是周六，则将在3号下周一触发。(注，”W”前只能设置具体的数字,不允许区间”-“)。<br><strong>小提示</strong>：’L’和 ‘W’可以一组合使用。如果在日字段上设置”LW”,则表示在本月的最后一个工作日触发；周字段的设置，若使用英文字母是不区分大小写的，即MON与mon相同。<br><strong>通配符#</strong>：表示每月的第几个周几。例如在周字段上设置”6#3”表示在每月的第三个周六。注意如果指定”#5”，正好第五周没有周六，则不会触发该配置(用在母亲节和父亲节再合适不过了)。<br><em>*注</em></em>：表中月份一行的JAN-DEC，是指一月到十二月的英文缩写；星期一行的SUN-SAT，是指星期天到星期六的英文缩写</p>
<h2 id="Crontab案例"><a href="#Crontab案例" class="headerlink" title="Crontab案例"></a>Crontab案例</h2><p><img src="http://oulmk4pq1.bkt.clouddn.com/quartz/quartz7.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/07/Jave-Unsafe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/Jave-Unsafe/" itemprop="url">Jave Unsafe类源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T16:23:56+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jdk/" itemprop="url" rel="index">
                    <span itemprop="name">jdk</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/07/Jave-Unsafe/" class="leancloud_visitors" data-flag-title="Jave Unsafe类源码解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h1><h2 id="创建UnSafe实例"><a href="#创建UnSafe实例" class="headerlink" title="创建UnSafe实例"></a>创建UnSafe实例</h2><p>默认必须是Java jdk自身类才能getUnsafe()获得实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static Unsafe getUnsafe() &#123;</div><div class="line">    Class var0 = Reflection.getCallerClass();</div><div class="line">    //判断是否是JDK内部专属的类，是则可以使用，否者抛出异常。</div><div class="line">    //JDK内部专属的类使用系统类加载器加载(系统类加载器为null)</div><div class="line">    if(!VM.isSystemDomainLoader(var0.getClassLoader())) &#123;</div><div class="line">        throw new SecurityException(&quot;Unsafe&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">        return theUnsafe;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果个人想要使用UnSafe类，可以通过反射获得Unsafe对象，theUnsafe是Unsafe的Field</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">        try &#123;</div><div class="line">            PrivilegedExceptionAction e = new PrivilegedExceptionAction() &#123;</div><div class="line">                public Unsafe run() throws Exception &#123;</div><div class="line">                    Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</div><div class="line">                    theUnsafe.setAccessible(true);</div><div class="line">                    return (Unsafe)theUnsafe.get((Object)null);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            THE_UNSAFE = (Unsafe) AccessController.doPrivileged(e);</div><div class="line">        &#125; catch (Exception var1) &#123;</div><div class="line">            throw new RuntimeException(&quot;Unable to load unsafe&quot;, var1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="对象内存结构"><a href="#对象内存结构" class="headerlink" title="对象内存结构"></a>对象内存结构</h2><p>可获得/设置对象内存结构中各偏移量offSet（相对于对象在内存中的起始位置的偏移）位置的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//获得对象（包含数组）中偏移量offset的int值，当为数组时，意思为指定数组元素指向的内存或值</div><div class="line">public native int getInt(Object obj, long offSet);</div><div class="line"></div><div class="line">//设置对象中偏移量offSet的值为value</div><div class="line">public native void putInt(Object obj, long offSet, int value);</div><div class="line"></div><div class="line">其他类似</div><div class="line">Object/Boolean/Byte/Short/Char/Long/Float/Double</div></pre></td></tr></table></figure>
<h2 id="内存位置"><a href="#内存位置" class="headerlink" title="内存位置"></a>内存位置</h2><p>可直接操控内存位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//获得堆外offSet位置的byte值</div><div class="line">public native byte getByte(long position);</div><div class="line"></div><div class="line">//在堆外offSet位置,设置内容value</div><div class="line">public native void putByte(long position, byte value);</div><div class="line"></div><div class="line">其他类似</div><div class="line">/Short/Char/Long/Float/Double</div></pre></td></tr></table></figure>
<h2 id="内存分配-复制-释放"><a href="#内存分配-复制-释放" class="headerlink" title="内存分配/复制/释放"></a>内存分配/复制/释放</h2><p>UnSafe的内存分配在堆外，尽量自己释放内存，编码内存溢出OOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">//获得var1指向的内存地址</div><div class="line">public native long getAddress(long var1);</div><div class="line"></div><div class="line">//设置var1指向var3</div><div class="line">public native void putAddress(long var1, long var3);</div><div class="line"></div><div class="line">//分配var1字节大小的内存，返回起始地址偏移量</div><div class="line">public native long allocateMemory(long var1);</div><div class="line"></div><div class="line">//重新给var1起始地址的内存分配长度为var3字节大小的内存，返回新的内存起始地址偏移量</div><div class="line">public native long reallocateMemory(long var1, long var3);</div><div class="line"></div><div class="line">//给定的内存块设置value</div><div class="line">public native void setMemory(Object obj, long offSet, long bytes, byte value);</div><div class="line"></div><div class="line">//给定的内存块设置value</div><div class="line">public void setMemory(long offSet, long bytes, byte value) &#123;</div><div class="line">        this.setMemory((Object)null, var1, var3, var5);</div><div class="line">&#125;</div><div class="line">//从srcObj对象的srcOffset位置开始复制bytes个字节到destObj（从destOffset开始）</div><div class="line">public native void copyMemory(Object srcObj, long srcOffset, Object destObj, long destOffset, long bytes);</div><div class="line"></div><div class="line">//从srcOffset复制bytes个字节到destOffset开始的内存块</div><div class="line">public void copyMemory(long srcOffset, long destOffset, long bytes) &#123;</div><div class="line">        this.copyMemory((Object)null, var1, (Object)null, var3, var5);</div><div class="line">&#125;</div><div class="line">//释放起始地址为var1的内存</div><div class="line">public native void freeMemory(long var1);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//获取本机内存的页数，这个值永远都是2的幂次方</div><div class="line">public native int pageSize();</div><div class="line"></div><div class="line">public native int addressSize();</div></pre></td></tr></table></figure>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//获取数组中第一个元素的偏移量(get offset of a first element in the array)，如果是对象数组，这个offSet存的数据为对象的引用内存地址，可通过UNSAFE.getLong(array,offSet)获得</div><div class="line">public native int arrayBaseOffset(java.lang.Class aClass);</div><div class="line"></div><div class="line">//获取数组中一个元素的大小(get size of an element in the array)  </div><div class="line">public native int arrayIndexScale(java.lang.Class aClass);</div></pre></td></tr></table></figure>
<h2 id="对象Field"><a href="#对象Field" class="headerlink" title="对象Field"></a>对象Field</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//获取字节对象中非静态方法的偏移量,不管这个字段是private，public还是保护类型</div><div class="line">public native long objectFieldOffset(java.lang.reflect.Field field);  </div><div class="line"></div><div class="line">//获取静态变量所属的类在方法区的首地址</div><div class="line">public native long staticFieldOffset(Field var1);</div><div class="line"></div><div class="line">//获取一个给定静态Field所在的Class对象</div><div class="line">public native Object staticFieldBase(Field f);</div></pre></td></tr></table></figure>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//告诉虚拟机定义了一个没有安全检查的类，默认情况下这个类加载器和保护域来着调用者类</div><div class="line">public native Class&lt;?&gt; defineClass(String var1, byte[] classContent, int begin, int classContentLength, ClassLoader var5, ProtectionDomain var6);</div><div class="line"></div><div class="line">//定义一个类，但是不让它知道类加载器和系统字典</div><div class="line">public native Class&lt;?&gt; defineAnonymousClass(Class&lt;?&gt; var1, byte[] classContent, Object[] cpPatches);</div><div class="line"></div><div class="line">//实例化对象，不调用构造函数</div><div class="line">public native Object allocateInstance(Class&lt;?&gt; var1) throws InstantiationException;</div><div class="line"></div><div class="line">//给定class是否应被初始化</div><div class="line">public native boolean shouldBeInitialized(Class&lt;?&gt; var1);</div><div class="line"></div><div class="line">//确保给定class被初始化，这往往需要结合基类的静态域（field）</div><div class="line">public native void ensureClassInitialized(Class c);</div></pre></td></tr></table></figure>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//包装异常为运行时异常</div><div class="line">public native void throwException(Throwable var1);</div></pre></td></tr></table></figure>
<h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public final native boolean compareAndSwapObject(Object obj, long address, Object oldValue, Object newValue);</div><div class="line"></div><div class="line">public final native boolean compareAndSwapInt(Object obj, long address, int oldValue, int newValue);</div><div class="line"></div><div class="line">public final native boolean compareAndSwapLong(Object obj, long address, long oldValue, long newValue);</div></pre></td></tr></table></figure>
<h2 id="get-putXXVolatile"><a href="#get-putXXVolatile" class="headerlink" title="get/putXXVolatile"></a>get/putXXVolatile</h2><p>内存屏障+立即可见，写操作使用较慢的存储-加载(store-load) barrier</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//获得对象offSet的值，支持volatile load语义</div><div class="line">public native Object getObjectVolatile(Object obj, long offSet);</div><div class="line"></div><div class="line">//设置对象offSet的值，支持volatile load语义，</div><div class="line">public native void putObjectVolatile(Object obj, long offSet, Object value);</div><div class="line"></div><div class="line">其他类似</div><div class="line">Int/Boolean/Byte/Short/Char/Long/Float/Double</div></pre></td></tr></table></figure>
<h2 id="putOrderedObject-Int-Long"><a href="#putOrderedObject-Int-Long" class="headerlink" title="putOrderedObject/Int/Long"></a>putOrderedObject/Int/Long</h2><p>是putObjectVolatile的内存屏障非立即可见版本，使用的是快速的存储-存储(store-store) barrier</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public native void putOrderedObject(Object var1, long var2, Object var4);</div><div class="line"></div><div class="line">public native void putOrderedInt(Object var1, long var2, int var4);</div><div class="line"></div><div class="line">public native void putOrderedLong(Object var1, long var2, long var4);</div></pre></td></tr></table></figure>
<h2 id="线程park-unpark"><a href="#线程park-unpark" class="headerlink" title="线程park/unpark"></a>线程park/unpark</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//解除阻塞线程</div><div class="line">public native void unpark(Object thread);</div><div class="line">//阻塞当前线程，boolean:true,绝对时间毫秒，false:相对时间，纳秒</div><div class="line">public native void park(boolean var1, long var2);</div></pre></td></tr></table></figure>
<p>将一个线程进行挂起是通过park方法实现的，调用 park后，线程将一直阻塞直到超时或者中断等条件出现。unpark可以终止一个挂起的线程，使其恢复正常。整个并发框架中对线程的挂起操作被封装在 LockSupport类中，LockSupport类中有各种版本pack方法，但最终都调用了Unsafe.park()方法。</p>
<h2 id="获取负载"><a href="#获取负载" class="headerlink" title="获取负载"></a>获取负载</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//获取系统在不同时间系统的负载情况</div><div class="line">public native int getLoadAverage(double[] loadavg, int nelems);</div></pre></td></tr></table></figure>
<h2 id="getAndAddXX"><a href="#getAndAddXX" class="headerlink" title="getAndAddXX"></a>getAndAddXX</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public final int getAndAddInt(Object var1, long var2, int var4) &#123;</div><div class="line">        int var5;</div><div class="line">        do &#123;</div><div class="line">            var5 = this.getIntVolatile(var1, var2);</div><div class="line">        &#125; while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));</div><div class="line">        return var5;</div><div class="line">    &#125;</div><div class="line">public final long getAndAddLong(Object var1, long var2, long var4) &#123;&#125;</div><div class="line">   </div><div class="line">public final int getAndSetInt(Object var1, long var2, int var4) &#123;</div><div class="line">        int var5;</div><div class="line">        do &#123;</div><div class="line">            var5 = this.getIntVolatile(var1, var2);</div><div class="line">        &#125; while(!this.compareAndSwapInt(var1, var2, var5, var4));</div><div class="line">        return var5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public final long getAndSetLong(Object var1, long var2, long var4) &#123;&#125;</div><div class="line"></div><div class="line">public final Object getAndSetObject(Object var1, long var2, Object var4) &#123;&#125;</div></pre></td></tr></table></figure>
<h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public native void loadFence();</div><div class="line">public native void storeFence();</div><div class="line">public native void fullFence();</div></pre></td></tr></table></figure>
<h1 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h1><h2 id="非常规的对象实例化"><a href="#非常规的对象实例化" class="headerlink" title="非常规的对象实例化"></a>非常规的对象实例化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public native Object allocateInstance(Class&lt;?&gt; var1) throws InstantiationException;</div></pre></td></tr></table></figure>
<ul>
<li>allocateInstance()方法提供了另一种创建实例的途径。通常我们可以用new或者反射来实例化对象，使用allocateInstance()方法可以直接生成对象实例，且无需调用构造方法和其它初始化方法。</li>
<li>这在对象反序列化的时候会很有用，能够重建和设置final字段，而不需要调用构造方法。</li>
</ul>
<h2 id="修改对象属性"><a href="#修改对象属性" class="headerlink" title="修改对象属性"></a>修改对象属性</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class TrapEntity &#123;</div><div class="line">    int id;</div><div class="line">    String alarmName;</div><div class="line">    public int getId() &#123;</div><div class="line">        return id;</div><div class="line">    &#125;</div><div class="line">    public void setId(int id) &#123;</div><div class="line">        this.id = id;</div><div class="line">    &#125;</div><div class="line">    public String getAlarmName() &#123;</div><div class="line">        return alarmName;</div><div class="line">    &#125;</div><div class="line">    public void setAlarmName(String alarmName) &#123;</div><div class="line">        this.alarmName = alarmName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">//通过offSet修改对象属性</div><div class="line">   private static void changeValueByOffSetTest() &#123;</div><div class="line">       TrapEntity entity = new TrapEntity();</div><div class="line">       entity.setId(1);</div><div class="line">       entity.setAlarmName(&quot;alarm1&quot;);</div><div class="line">       try &#123;</div><div class="line">           long alarmNameOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;alarmName&quot;));</div><div class="line">           long idOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;id&quot;));</div><div class="line">           System.out.println(alarmNameOffSet);</div><div class="line">           UNSAFE.putObject(entity, alarmNameOffSet, &quot;alarmName2&quot;);</div><div class="line">           System.out.println(entity.getAlarmName());</div><div class="line">           System.out.println(idOffSet);</div><div class="line">           UNSAFE.putInt(entity, idOffSet, 2);</div><div class="line">           System.out.println(entity.getId());</div><div class="line"></div><div class="line">       &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">           e.printStackTrace();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">       </div><div class="line">//通过内存位置修改对象属性</div><div class="line">   private static void changeValueByPositionTest() &#123;</div><div class="line">       TrapEntity entity = new TrapEntity();</div><div class="line">       entity.setId(1);</div><div class="line">       entity.setAlarmName(&quot;alarm1&quot;);</div><div class="line">       Long pos = UnSafeUtils.getObjectPos(entity);</div><div class="line">       System.out.println(&quot;getObjectPos = &quot; + pos);</div><div class="line"></div><div class="line">       try &#123;</div><div class="line">           long idOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;id&quot;));</div><div class="line">           long idPos = pos + idOffSet;</div><div class="line">           System.out.println(&quot;old value = &quot; + UNSAFE.getInt(idPos));</div><div class="line"></div><div class="line">           UNSAFE.putInt(idPos, 2);</div><div class="line">           System.out.println(&quot;new value = &quot; + entity.getId());</div><div class="line"></div><div class="line">       &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">           e.printStackTrace();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="计算对象大小"><a href="#计算对象大小" class="headerlink" title="计算对象大小"></a>计算对象大小</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>所占空间（byte）</th>
</tr>
</thead>
<tbody>
<tr>
<td>byte</td>
<td>1</td>
</tr>
<tr>
<td>short</td>
<td>2</td>
</tr>
<tr>
<td>int</td>
<td>4</td>
</tr>
<tr>
<td>long</td>
<td>8</td>
</tr>
<tr>
<td>float</td>
<td>4</td>
</tr>
<tr>
<td>double</td>
<td>8</td>
</tr>
<tr>
<td>char</td>
<td>2</td>
</tr>
<tr>
<td>boolean</td>
<td>1</td>
</tr>
<tr>
<td>Object</td>
<td>对象引用4/8</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>对象类型</th>
<th>内存布局构成</th>
</tr>
</thead>
<tbody>
<tr>
<td>一般非数组对象</td>
<td>8个字节对象头(mark) + 4/8字节对象指针 + 数据区 + padding内存对齐(按照8的倍数对齐)</td>
</tr>
<tr>
<td>数组对象</td>
<td>8个字节对象头(mark) + 4/8字节对象指针 + 4字节数组长度 + 数据区 + padding内存对齐(按照8的倍数对齐)</td>
</tr>
</tbody>
</table>
<p>对象指针究竟是4字节还是8字节要看是否开启指针压缩。Oracle JDK从6 update 23开始在64位系统上会默认开启压缩指针，基础数据包装类及对象引用会变为4字节。</p>
<p>计算原理：获得所有Field（包括父类Field）的偏移量，取最大偏移量对应的属性最大4（开启压缩）/8字节，object对象大小是8的倍数，不足时做对齐填充，所以对象大小为：(maxOffSet/8+1)*8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class ObjectA &#123;</div><div class="line">    String str;   // 4</div><div class="line">    int int1;       // 4</div><div class="line">    Integer Int2;</div><div class="line">    byte byte1;      // 1</div><div class="line">    Byte Byte2;</div><div class="line">    char char1; //2</div><div class="line">    Character Char2;</div><div class="line">    boolean boolean1;//1</div><div class="line">    Boolean BooLean2;</div><div class="line">    long long1;//4</div><div class="line">    Long Long2;</div><div class="line">    float float1;//4</div><div class="line">    Float Float2;</div><div class="line">    double double1;//</div><div class="line">    Double Double2;</div><div class="line">    ObjectB obj;  //4</div><div class="line">    int[] intArray;</div><div class="line">    volatile ObjectB[] objs;</div><div class="line">    volatile ObjectB[] objs2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public class ObjectB &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">  //**获得对象大小</div><div class="line">    public static long sizeOf(Object obj) &#123;</div><div class="line">        Class clazz = obj.getClass();</div><div class="line">        //为了观察每个field大小，对field的offSet进行了排序，后者-前者=前者大小</div><div class="line">        TreeSet&lt;Field&gt; hashSet = new TreeSet(new Comparator() &#123;</div><div class="line">            @Override</div><div class="line">            public int compare(Object o1, Object o2) &#123;</div><div class="line">                Field f1=(Field)o1;</div><div class="line">                Field f2=(Field)o2;</div><div class="line">                long offSet1 = UNSAFE.objectFieldOffset(f1);</div><div class="line">                long offSet2 = UNSAFE.objectFieldOffset(f2);</div><div class="line">                return Integer.parseInt((offSet1 - offSet2)+&quot;&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        while (clazz != Object.class) &#123;</div><div class="line">            Field[] fields = clazz.getDeclaredFields();</div><div class="line">            for (Field field : fields) &#123;</div><div class="line">                if (!Modifier.isStatic(field.getModifiers())) &#123;</div><div class="line">                    hashSet.add(field);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            clazz = clazz.getSuperclass();</div><div class="line">        &#125;</div><div class="line">        long maxOffSet=0;</div><div class="line">        for (Field field : hashSet) &#123;</div><div class="line">            long offSet = UNSAFE.objectFieldOffset(field);</div><div class="line">            System.out.println(field.getName() + &quot; offSet = &quot; + offSet);</div><div class="line">            if(offSet&gt;maxOffSet)&#123;</div><div class="line">                maxOffSet=offSet;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;maxOffSet = &quot;+maxOffSet);</div><div class="line"></div><div class="line">        return (maxOffSet/8+1)*8;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>开启指针压缩结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">int1 offSet = 12</div><div class="line">long1 offSet = 16</div><div class="line">double1 offSet = 24</div><div class="line">float1 offSet = 32</div><div class="line">char1 offSet = 36</div><div class="line">byte1 offSet = 38</div><div class="line">boolean1 offSet = 39</div><div class="line">str offSet = 40</div><div class="line">Int2 offSet = 44</div><div class="line">Byte2 offSet = 48</div><div class="line">Char2 offSet = 52</div><div class="line">BooLean2 offSet = 56</div><div class="line">Long2 offSet = 60</div><div class="line">Float2 offSet = 64</div><div class="line">Double2 offSet = 68</div><div class="line">obj offSet = 72</div><div class="line">intArray offSet = 76</div><div class="line">objs offSet = 80</div><div class="line">objs2 offSet = 84</div><div class="line">maxOffSet = 84</div><div class="line">88</div></pre></td></tr></table></figure>
<p>未开启指针压缩结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">long1 offSet = 16</div><div class="line">double1 offSet = 24</div><div class="line">int1 offSet = 32</div><div class="line">float1 offSet = 36</div><div class="line">char1 offSet = 40</div><div class="line">byte1 offSet = 42</div><div class="line">boolean1 offSet = 43</div><div class="line">str offSet = 48</div><div class="line">Int2 offSet = 56</div><div class="line">Byte2 offSet = 64</div><div class="line">Char2 offSet = 72</div><div class="line">BooLean2 offSet = 80</div><div class="line">Long2 offSet = 88</div><div class="line">Float2 offSet = 96</div><div class="line">Double2 offSet = 104</div><div class="line">obj offSet = 112</div><div class="line">intArray offSet = 120</div><div class="line">objs offSet = 128</div><div class="line">objs2 offSet = 136</div><div class="line">maxOffSet = 136</div><div class="line">144</div></pre></td></tr></table></figure>
<p>根据打印的结果可知：</p>
<p>开启了指针压缩，基础数据包装类及对象引用被压缩为4字节，最小属性起始为为12=8个字节对象头(mark) + 4字节对象指针，属性实际数据应该是在13，所以根据maxOffSet=84得出对象实际大小范围在maxOffSet+1=85到maxOffSet+4=88之间，padding后size=88，与公式(maxOffSet/8+1)*8计算一致</p>
<p>未开启了指针压缩，基础数据包装类及对象引用为8字节，最小属性起始为为16=8个字节对象头(mark) + 8字节对象指针，属性实际数据应该是在17，所以根据maxOffSet=136得出对象大小范围在maxOffSet+1=137到maxOffSet+8=144之间，padding后size=155，与公式(maxOffSet/8+1)*8计算一致</p>
<h2 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h2><p>通过复制内存数据的方式实现浅拷贝。</p>
<p>浅拷贝：只复制值对象，不复制引用对象，引用对象指向同一对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public static void shallowCopyTest() &#123;</div><div class="line">        ObjectA objectA=new ObjectA();</div><div class="line">        objectA.setStr(&quot;I&apos;m ObjectA&quot;);</div><div class="line">        objectA.setInt1(1);</div><div class="line">        long size = sizeOf(objectA);//获得对象大小</div><div class="line">        long start = getObjectPos(objectA);//获得obj起始内存地址</div><div class="line">        System.out.println(&quot;getObjectPos = &quot;+start);</div><div class="line">        long address = UNSAFE.allocateMemory(size);//分配size大小的内存空间，返回内存起始地址</div><div class="line">        System.out.println(&quot;allocateMemory address = &quot;+address);</div><div class="line">        UNSAFE.copyMemory(start, address, size); //从start位copy size个大小的内存内容到目标地址address</div><div class="line">        ObjectA ObjectACopy= (ObjectA) createObjByPointer(address);</div><div class="line">        ObjectACopy.setInt1(11);</div><div class="line">        //浅复制只能修改基本数据类型，修改对象引用运行会报error</div><div class="line">//        ObjectACopy.setStr(&quot;I&apos;m ObjectA Copy&quot;);//A fatal error has been detected by the Java Runtime Environment</div><div class="line">        System.out.println(objectA.getInt1());</div><div class="line">        System.out.println(ObjectACopy.getInt1());</div><div class="line">        UNSAFE.freeMemory(address);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public static Object shallowCopy(Object obj) &#123;</div><div class="line">       long size = sizeOf(obj);//获得对象大小</div><div class="line">       long start = getObjectPos(obj);//获得obj起始内存地址</div><div class="line">       long address = UNSAFE.allocateMemory(size);//分配size大小的内存空间，返回内存起始地址</div><div class="line">       UNSAFE.copyMemory(start, address, size); //从start位copy size个大小的内存内容到目标地址address</div><div class="line">       return createObjByPointer(address);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="获取对象内存地址"><a href="#获取对象内存地址" class="headerlink" title="获取对象内存地址"></a>获取对象内存地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//获得对象内存位置</div><div class="line">public static Long getObjectPos(Object obj) &#123;</div><div class="line">        Object[] array = new Object[]&#123;obj&#125;;</div><div class="line">        return UNSAFE.getLong(array, Long.valueOf(UNSAFE.ARRAY_OBJECT_BASE_OFFSET));//获得baseOffset位置内存地址</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="创建对象：指定内存地址的方式"><a href="#创建对象：指定内存地址的方式" class="headerlink" title="创建对象：指定内存地址的方式"></a>创建对象：指定内存地址的方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//通过制定内存指针位置的方式创建对象</div><div class="line">public static Object createObjByPointer(long address) &#123;</div><div class="line">        Object[] array = new Object[] &#123;null&#125;;</div><div class="line">        long baseOffset = UNSAFE.arrayBaseOffset(Object[].class);</div><div class="line">        UNSAFE.putLong(array, baseOffset, address);//baseOffset指向address</div><div class="line">        return array[0];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="动态加载类defineClass"><a href="#动态加载类defineClass" class="headerlink" title="动态加载类defineClass"></a>动态加载类defineClass</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">    private static void defineClassTest() &#123;</div><div class="line">        byte[] classContents = new byte[0];</div><div class="line">        try &#123;</div><div class="line">            classContents = getClassContent();</div><div class="line">            Class c = UNSAFE.defineClass(null, classContents, 0, classContents.length,null,null);</div><div class="line">            Method m=c.getMethod(&quot;getId&quot;);</div><div class="line">            Object res =m.invoke(c.newInstance(),null);</div><div class="line">            System.out.println(res);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">    //getClassContent()方法，将一个class文件，读取到一个byte数组。</div><div class="line">    private static byte[] getClassContent() throws Exception &#123;</div><div class="line">        File f = new File(&quot;E:\\GAE\\rocky\\rocky-disruptor\\target\\classes\\rocky\\com\\pojo\\TrapEntity.class&quot;);</div><div class="line">        FileInputStream input = new FileInputStream(f);</div><div class="line">        byte[] content = new byte[(int)f.length()];</div><div class="line">        input.read(content);</div><div class="line">        input.close();</div><div class="line">        return content;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="包装受检异常为运行时异常-不建议使用"><a href="#包装受检异常为运行时异常-不建议使用" class="headerlink" title="包装受检异常为运行时异常(不建议使用)"></a>包装受检异常为运行时异常(不建议使用)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getUnsafe().throwException(new IOException());</div></pre></td></tr></table></figure>
<h2 id="堆外分配内存"><a href="#堆外分配内存" class="headerlink" title="堆外分配内存"></a>堆外分配内存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">address = getUnsafe().allocateMemory(size);</div></pre></td></tr></table></figure>
<h2 id="无锁并发CAS"><a href="#无锁并发CAS" class="headerlink" title="无锁并发CAS"></a>无锁并发CAS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class CASCounter &#123;</div><div class="line">    private volatile long counter = 0;</div><div class="line">    private Unsafe unsafe= UnSafeUtils.getUnsafe();</div><div class="line">    private long offset;</div><div class="line"></div><div class="line">    public CASCounter() throws Exception &#123;</div><div class="line">        offset = unsafe.objectFieldOffset(CASCounter.class.getDeclaredField(&quot;counter&quot;));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void increment() &#123;</div><div class="line">        long before = counter;</div><div class="line">        while (!unsafe.compareAndSwapLong(this, offset, before, before + 1)) &#123;</div><div class="line">            before = counter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getCounter() &#123;</div><div class="line">        return counter;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h1><h2 id="UnSafeUtils"><a href="#UnSafeUtils" class="headerlink" title="UnSafeUtils"></a>UnSafeUtils</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">package rocky.com.util;</div><div class="line"></div><div class="line">import sun.misc.Unsafe;</div><div class="line"></div><div class="line">import java.lang.reflect.Field;</div><div class="line">import java.lang.reflect.Modifier;</div><div class="line">import java.security.AccessController;</div><div class="line">import java.security.PrivilegedExceptionAction;</div><div class="line">import java.util.Comparator;</div><div class="line">import java.util.TreeSet;</div><div class="line"></div><div class="line">public class UnSafeUtils &#123;</div><div class="line">    private static final Unsafe UNSAFE;</div><div class="line">    static &#123;</div><div class="line">        try &#123;</div><div class="line">            PrivilegedExceptionAction e = new PrivilegedExceptionAction() &#123;</div><div class="line">                public Unsafe run() throws Exception &#123;</div><div class="line">                    Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</div><div class="line">                    theUnsafe.setAccessible(true);</div><div class="line">                    return (Unsafe)theUnsafe.get((Object)null);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            UNSAFE = (Unsafe) AccessController.doPrivileged(e);</div><div class="line">        &#125; catch (Exception var1) &#123;</div><div class="line">            throw new RuntimeException(&quot;Unable to load unsafe&quot;, var1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static Unsafe getUnsafe() &#123;</div><div class="line">        return UNSAFE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    //**获得对象大小</div><div class="line">    public static long sizeOf(Object obj) &#123;</div><div class="line">        Class clazz = obj.getClass();</div><div class="line">        //为了观察每个field大小，对field的offSet进行了排序，后者-前者=前者大小</div><div class="line">        TreeSet&lt;Field&gt; hashSet = new TreeSet(new Comparator() &#123;</div><div class="line">            @Override</div><div class="line">            public int compare(Object o1, Object o2) &#123;</div><div class="line">                Field f1=(Field)o1;</div><div class="line">                Field f2=(Field)o2;</div><div class="line">                long offSet1 = UNSAFE.objectFieldOffset(f1);</div><div class="line">                long offSet2 = UNSAFE.objectFieldOffset(f2);</div><div class="line">                return Integer.parseInt((offSet1 - offSet2)+&quot;&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        while (clazz != Object.class) &#123;</div><div class="line">            Field[] fields = clazz.getDeclaredFields();</div><div class="line">            for (Field field : fields) &#123;</div><div class="line">                if (!Modifier.isStatic(field.getModifiers())) &#123;</div><div class="line">                    hashSet.add(field);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            clazz = clazz.getSuperclass();</div><div class="line">        &#125;</div><div class="line">        long maxOffSet=0;</div><div class="line">        for (Field field : hashSet) &#123;</div><div class="line">            long offSet = UNSAFE.objectFieldOffset(field);</div><div class="line">            System.out.println(field.getName() + &quot; offSet = &quot; + offSet);</div><div class="line">            if(offSet&gt;maxOffSet)&#123;</div><div class="line">                maxOffSet=offSet;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;maxOffSet = &quot;+maxOffSet);</div><div class="line"></div><div class="line">        return (maxOffSet/8+1)*8;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //浅拷贝</div><div class="line">    public static Object shallowCopy(Object obj) &#123;</div><div class="line">        long size = sizeOf(obj);//获得对象大小</div><div class="line">        long start = getObjectPos(obj);//获得obj起始内存地址</div><div class="line">        long address = UNSAFE.allocateMemory(size);//分配size大小的内存空间，返回内存起始地址</div><div class="line">        UNSAFE.copyMemory(start, address, size); //从start位copy size个大小的内存内容到目标地址address</div><div class="line">        return createObjByPointer(address);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //获得对象内存位置</div><div class="line">    public static Long getObjectPos(Object obj) &#123;</div><div class="line">        Object[] array = new Object[]&#123;obj&#125;;</div><div class="line">        return UNSAFE.getLong(array, Long.valueOf(UNSAFE.ARRAY_OBJECT_BASE_OFFSET));//获得baseOffset位置内存地址</div><div class="line">    &#125;</div><div class="line">    //通过制定内存指针位置的方式创建对象</div><div class="line">    public static Object createObjByPointer(long address) &#123;</div><div class="line">        Object[] array = new Object[] &#123;null&#125;;</div><div class="line">        long baseOffset = UNSAFE.arrayBaseOffset(Object[].class);</div><div class="line">        UNSAFE.putLong(array, baseOffset, address);//baseOffset指向address</div><div class="line">        return array[0];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h2><h3 id="TrapEntity"><a href="#TrapEntity" class="headerlink" title="TrapEntity"></a>TrapEntity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class TrapEntity &#123;</div><div class="line">    int id;</div><div class="line">    String alarmName;</div><div class="line"></div><div class="line">    public int getId() &#123;</div><div class="line">        return id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setId(int id) &#123;</div><div class="line">        this.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getAlarmName() &#123;</div><div class="line">        return alarmName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setAlarmName(String alarmName) &#123;</div><div class="line">        this.alarmName = alarmName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ObjectA"><a href="#ObjectA" class="headerlink" title="ObjectA"></a>ObjectA</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class ObjectA &#123;</div><div class="line">    String str;   // 4</div><div class="line">    int int1;       // 4</div><div class="line">    Integer Int2;</div><div class="line">    byte byte1;      // 1</div><div class="line">    Byte Byte2;</div><div class="line">    char char1; //2</div><div class="line">    Character Char2;</div><div class="line">    boolean boolean1;//1</div><div class="line">    Boolean BooLean2;</div><div class="line">    long long1;//4</div><div class="line">    Long Long2;</div><div class="line">    float float1;//4</div><div class="line">    Float Float2;</div><div class="line">    double double1;//8</div><div class="line">    Double Double2;</div><div class="line">    ObjectB obj;  //4</div><div class="line">    int[] intArray;</div><div class="line">    volatile ObjectB[] objs;</div><div class="line">    volatile ObjectB[] objs2;</div><div class="line"></div><div class="line">//get/set 省略</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ObjectB"><a href="#ObjectB" class="headerlink" title="ObjectB"></a>ObjectB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public class ObjectB &#123;</div><div class="line">	static int staticFile;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="UnSafeTest"><a href="#UnSafeTest" class="headerlink" title="UnSafeTest"></a>UnSafeTest</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line">package rocky.com;</div><div class="line"></div><div class="line">import rocky.com.pojo.TrapEntity;</div><div class="line">import rocky.com.util.UnSafeUtils;</div><div class="line">import sun.misc.Unsafe;</div><div class="line"></div><div class="line"></div><div class="line">public class UnSafeTest &#123;</div><div class="line"></div><div class="line"></div><div class="line">    private static final Unsafe UNSAFE = UnSafeUtils.getUnsafe();</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">//        changeValueByOffSetTest();</div><div class="line">//        printConstant();</div><div class="line">//        changeValueByPositionTest();</div><div class="line">//       long size= UnSafeUtils.sizeOf(new ObjectA());</div><div class="line">//      System.out.println(size);</div><div class="line">//        shallowCopyTest();</div><div class="line">//objectStaticFieldTest();</div><div class="line">defineClassTest();</div><div class="line">        System.exit(0);</div><div class="line">    &#125;</div><div class="line">    private static void defineClassTest() &#123;</div><div class="line"></div><div class="line">        byte[] classContents = new byte[0];</div><div class="line">        try &#123;</div><div class="line">            classContents = getClassContent();</div><div class="line">            Class c = UNSAFE.defineClass(null, classContents, 0, classContents.length,null,null);</div><div class="line">            Method m=c.getMethod(&quot;getId&quot;);</div><div class="line">            Object res =m.invoke(c.newInstance(),null);</div><div class="line">            System.out.println(res);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">    //getClassContent()方法，将一个class文件，读取到一个byte数组。</div><div class="line">    private static byte[] getClassContent() throws Exception &#123;</div><div class="line">        File f = new File(&quot;E:\\GAE\\rocky\\rocky-disruptor\\target\\classes\\rocky\\com\\pojo\\TrapEntity.class&quot;);</div><div class="line">        FileInputStream input = new FileInputStream(f);</div><div class="line">        byte[] content = new byte[(int)f.length()];</div><div class="line">        input.read(content);</div><div class="line">        input.close();</div><div class="line">        return content;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //测试staticFieldBase方法，返回Class对象</div><div class="line">private static void objectStaticFieldTest()&#123;</div><div class="line">    try &#123;</div><div class="line">        Class objB=   (Class) UNSAFE.staticFieldBase(ObjectB.class.getDeclaredField(&quot;staticFile&quot;));</div><div class="line">        System.out.println(objB.getName());</div><div class="line">    &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    //通过内存位置修改对象属性</div><div class="line">    private static void changeValueByPositionTest() &#123;</div><div class="line">        TrapEntity entity = new TrapEntity();</div><div class="line">        entity.setId(1);</div><div class="line">        entity.setAlarmName(&quot;alarm1&quot;);</div><div class="line">        Long pos = UnSafeUtils.getObjectPos(entity);</div><div class="line">        System.out.println(&quot;getObjectPos = &quot; + pos);</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            long idOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;id&quot;));</div><div class="line">            long idPos = pos + idOffSet;</div><div class="line">            System.out.println(&quot;old value = &quot; + UNSAFE.getInt(idPos));</div><div class="line">//            System.out.println(&quot;byte = &quot;+b);</div><div class="line">            UNSAFE.putInt(idPos, 2);</div><div class="line">            System.out.println(&quot;new value = &quot; + entity.getId());</div><div class="line"></div><div class="line">        &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void printConstant() &#123;</div><div class="line">        System.out.println(&quot;ADDRESS_SIZE = &quot;+UNSAFE.ADDRESS_SIZE);</div><div class="line">        System.out.println(&quot;ARRAY_OBJECT_BASE_OFFSET = &quot;+UNSAFE.ARRAY_OBJECT_BASE_OFFSET);</div><div class="line">        System.out.println(&quot;ARRAY_OBJECT_INDEX_SCALE = &quot;+UNSAFE.ARRAY_OBJECT_INDEX_SCALE);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    public static void shallowCopyTest() &#123;</div><div class="line">        ObjectA objectA=new ObjectA();</div><div class="line">        objectA.setStr(&quot;I&apos;m ObjectA&quot;);</div><div class="line">        objectA.setInt1(1);</div><div class="line">        long size = UnSafeUtils.sizeOf(objectA);//获得对象大小</div><div class="line">        long start = UnSafeUtils.getObjectPos(objectA);//获得obj起始内存地址</div><div class="line">        System.out.println(&quot;getObjectPos = &quot;+start);</div><div class="line">        long address = UNSAFE.allocateMemory(size);//分配size大小的内存空间，返回内存起始地址</div><div class="line">        System.out.println(&quot;allocateMemory address = &quot;+address);</div><div class="line">        UNSAFE.copyMemory(start, address, size); //从start位copy size个大小的内存内容到目标地址address</div><div class="line">        ObjectA ObjectACopy= (ObjectA) UnSafeUtils.createObjByPointer(address);</div><div class="line">        ObjectACopy.setInt1(11);</div><div class="line">        //浅复制只能修改基本数据类型，修改对象引用运行会报error</div><div class="line">//        ObjectACopy.setStr(&quot;I&apos;m ObjectA Copy&quot;);//A fatal error has been detected by the Java Runtime Environment</div><div class="line">        System.out.println(objectA.getInt1());</div><div class="line">        System.out.println(ObjectACopy.getInt1());</div><div class="line">        UNSAFE.freeMemory(address);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    //通过offSet修改对象属性</div><div class="line">    private static void changeValueByOffSetTest() &#123;</div><div class="line">        TrapEntity entity = new TrapEntity();</div><div class="line">        entity.setId(1);</div><div class="line">        entity.setAlarmName(&quot;alarm1&quot;);</div><div class="line">        try &#123;</div><div class="line">            long alarmNameOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;alarmName&quot;));</div><div class="line">            long idOffSet = UNSAFE.objectFieldOffset(entity.getClass().getDeclaredField(&quot;id&quot;));</div><div class="line">            System.out.println(alarmNameOffSet);</div><div class="line">            UNSAFE.putObject(entity, alarmNameOffSet, &quot;alarmName2&quot;);</div><div class="line">            System.out.println(entity.getAlarmName());</div><div class="line">            System.out.println(idOffSet);</div><div class="line">            UNSAFE.putInt(entity, idOffSet, 2);</div><div class="line">            System.out.println(entity.getId());</div><div class="line"></div><div class="line">        &#125; catch (NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CASCounter"><a href="#CASCounter" class="headerlink" title="CASCounter"></a>CASCounter</h2><p>无锁并发测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">package rocky.com;</div><div class="line"></div><div class="line">import rocky.com.util.UnSafeUtils;</div><div class="line">import sun.misc.Unsafe;</div><div class="line"></div><div class="line">public class CASCounter &#123;</div><div class="line">    private volatile long counter = 0;</div><div class="line">    private Unsafe unsafe= UnSafeUtils.getUnsafe();</div><div class="line">    private long offset;</div><div class="line"></div><div class="line">    public CASCounter() throws Exception &#123;</div><div class="line">        offset = unsafe.objectFieldOffset(CASCounter.class.getDeclaredField(&quot;counter&quot;));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    public void increment() &#123;</div><div class="line">        long before = counter;</div><div class="line">        while (!unsafe.compareAndSwapLong(this, offset, before, before + 1)) &#123;</div><div class="line">            before = counter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getCounter() &#123;</div><div class="line">        return counter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        try &#123;</div><div class="line">            CASCounter casCounter=new CASCounter();</div><div class="line">            Producer producer=new Producer(casCounter);</div><div class="line">            for (int i = 0; i &lt; 5; i++) &#123;</div><div class="line">                new Thread(producer).start();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">class Producer implements Runnable&#123;</div><div class="line">    CASCounter casCounter;</div><div class="line">    public Producer(CASCounter counter)&#123;</div><div class="line">        casCounter=counter;</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        while (true)&#123;</div><div class="line">            casCounter.increment();</div><div class="line">            System.out.println(Thread.currentThread().getName()+&quot; increment&quot;);</div><div class="line">            System.out.println(Thread.currentThread().getName()+&quot; casCounter = &quot;+casCounter.getCounter());</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(500);</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2018/02/07/Disruptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/Disruptor/" itemprop="url">Disruptor源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T15:47:19+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3rd-party-jars/" itemprop="url" rel="index">
                    <span itemprop="name">3rd party jars</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/07/Disruptor/" class="leancloud_visitors" data-flag-title="Disruptor源码解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><ul>
<li>缓存伪共享+缓存行填充</li>
<li>UNSAFE类方法功能</li>
</ul>
<ul>
<li>乐观锁CAS原子操作</li>
<li>Volatile+内存屏障</li>
</ul>
<h1 id="交互图"><a href="#交互图" class="headerlink" title="交互图"></a>交互图</h1><p><img src="http://oulmk4pq1.bkt.clouddn.com/disruptor/disruptor.png" alt=""></p>
<p>说明：</p>
<ul>
<li>箭头表示持有或等于引用对象，无箭头表示持有的变量</li>
<li>源码并不是官网提供的源码，而是开发工具反编译出来的</li>
</ul>
<ul>
<li>dependentSequence：前置消费者消费到的seq，有多个时使用FixedSequenceGroup，取最小的，若没有前置消费者，则为生产者cursor</li>
<li>Sequence[] gatingSequence：消费者链上最后一个消费者组消费到的seqs</li>
<li>核心代码：<ul>
<li>Sequencer.next()：生产者获得可用seq，发布事件</li>
<li>Processor.run()–&gt;sequenceBarrier.waitFor()–&gt;waitStrategy.waitFor()：消费者获得最大可用seq，读事件</li>
</ul>
</li>
</ul>
<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><ul>
<li>生产者持有RingBuffer的引用，调用ringBuffer.publish方法—-&gt;sequencer.next(); sequencer.publish()</li>
<li>Sequencer持有消费者链上最后一个消费者（组）消费到的seq（s），及cursor（当前生产者生产到的seq）<ul>
<li>next()方法判断生产者请求的seq的覆盖点是否覆盖了(&gt;)最慢消费者的seq，是则唤醒消费者并休眠，直到不覆盖返回请求的seq</li>
<li>publish()方法懒更新cursor：set并不立即可见，</li>
</ul>
</li>
</ul>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><p>Processor是消费者线程类，持有EventHandler做具体事件处理工作，记录当前消费到的seq，主要逻辑在run()方法：</p>
<ul>
<li>循环请求next=seq+1</li>
</ul>
<ul>
<li>调用sequenceBarrier.waitFor(next) 获得当前可消费的publishedSequence（小于等于cursor和dependentSequence，且发布了时间）<ul>
<li>内部实际是调用waitStrategy.waitFor(next)获得最慢消费者消费到的seq，称为availableSequence<ul>
<li>dependentSequence.get()&gt;next?return availableSequence=dependentSequence.get():继续循环判断</li>
<li>有些waitStrategy会先判断next和生产者cursor大小，直到next&lt;=cursor，再判断dependentSequence与next</li>
</ul>
</li>
<li>若此时availableSequence&gt;=next（可能存在批量消费，未被生产者再次写入事件），获得已写入事件的最大seq：sequencer.getHighestPublishedSequence(sequence, availableSequence);</li>
<li>若availableSequence&lt;next,返回seq//根据waitStrategy.waitFor的代码，貌似不会出现这种情况</li>
</ul>
</li>
<li>publishedSequence&gt;=next：处理next-&gt;publishedSequence之间的事件</li>
<li>publishedSequence&lt;next：更新cursor=publishedSequence</li>
</ul>
<h1 id="source"><a href="#source" class="headerlink" title="source"></a>source</h1><h2 id="Sequence"><a href="#Sequence" class="headerlink" title="Sequence"></a>Sequence</h2><ul>
<li>缓存行填充,填充14个long</li>
<li>protected volatile long value</li>
<li>set：延迟可见，UNSAFE.putOrderedLong(this, VALUE_OFFSET, value);</li>
<li>setVolatile：理解可见，UNSAFE.putLongVolatile(this, VALUE_OFFSET, value);</li>
<li>compareAndSet：</li>
</ul>
<h3 id="FixedSequenceGroup"><a href="#FixedSequenceGroup" class="headerlink" title="FixedSequenceGroup"></a>FixedSequenceGroup</h3><ul>
<li>extends Sequence</li>
<li>private final Sequence[] sequences</li>
<li>重新get方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public long get() &#123;</div><div class="line">        return Util.getMinimumSequence(this.sequences);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用于设置消费者的前置消费者seq，当消费者有多个前置消费者时使用</p>
<p>new ProcessingSequenceBarrier(){</p>
<p>​    //当dependentSequences.length&gt;1时</p>
<p>​    dependentSequence =new FixedSequenceGroup</p>
<p>}</p>
<h2 id="Sequencer"><a href="#Sequencer" class="headerlink" title="Sequencer"></a>Sequencer</h2><p>生产者与消费者的桥梁,生成消费者屏障barrier：</p>
<p>（1）消费者屏障barrier持有Sequencer及Sequencer的cursor；</p>
<p>（2）Sequencer持有消费者链上最后一个消费者组消费到的seqs，当生产者申请写入的seq覆盖了最慢消费者的seq时，阻塞等待；</p>
<p>（3）发布时事件时更新cursor，并通知消费者线程</p>
<p>（4）生产者先获得next()，再发布事件，next()方法判断nextSeq是否覆盖最慢消费者的seqs，如果是，则阻塞等待。</p>
<p>（5）next()时，this.cursor.setVolatile(nextValue)更新生产者cursor=上次请求成功的seq，其他线程立即看到变更，pulish()时，this.cursor.set(sequence);//set方法不保证其他线程立即看到变更，所以发布事件后，并不保证消费者可以立即知道并消费，只有在请求下一个槽位时，消费者可立即看到已发布事件的上一槽位。这部分不知道理解是否有误</p>
<p>重要属性及方法：</p>
<ul>
<li>protected final Sequence cursor = new Sequence(-1L)生产者生产到的最大seq</li>
<li>protected volatile Sequence[] gatingSequences//消费者链上最后一个消费者组消费到的seqs</li>
<li>next()</li>
<li>newBarrier()-&gt;new ProcessingSequenceBarrier(this, this.waitStrategy, this.cursor, sequencesToTrack);</li>
</ul>
<h3 id="AbstractSequencer"><a href="#AbstractSequencer" class="headerlink" title="AbstractSequencer"></a>AbstractSequencer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public abstract class AbstractSequencer implements Sequencer &#123;</div><div class="line">    private static final AtomicReferenceFieldUpdater&lt;AbstractSequencer, Sequence[]&gt; SEQUENCE_UPDATER = AtomicReferenceFieldUpdater.newUpdater(AbstractSequencer.class, Sequence[].class, &quot;gatingSequences&quot;);//原子更新需要跟踪的消费者seq,gatingSequences</div><div class="line">    protected final int bufferSize;//ringbuffer大小</div><div class="line">    protected final WaitStrategy waitStrategy;//等待策略</div><div class="line">    protected final Sequence cursor = new Sequence(-1L);//生产者生产到的seq</div><div class="line">    protected volatile Sequence[] gatingSequences = new Sequence[0];//需跟踪的消费者组消费到的seqs</div><div class="line"></div><div class="line">    public AbstractSequencer(int bufferSize, WaitStrategy waitStrategy) &#123;</div><div class="line">        if(bufferSize &lt; 1) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;bufferSize must not be less than 1&quot;);</div><div class="line">        &#125; else if(Integer.bitCount(bufferSize) != 1) &#123;//size必须是2的次方</div><div class="line">            throw new IllegalArgumentException(&quot;bufferSize must be a power of 2&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            this.bufferSize = bufferSize;</div><div class="line">            this.waitStrategy = waitStrategy;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public final long getCursor() &#123;</div><div class="line">        return this.cursor.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public final int getBufferSize() &#123;</div><div class="line">        return this.bufferSize;</div><div class="line">    &#125;</div><div class="line">    //原子添加需跟踪的前置消费者seq到数组</div><div class="line">    public final void addGatingSequences(Sequence... gatingSequences) &#123;</div><div class="line">        SequenceGroups.addSequences(this, SEQUENCE_UPDATER, this, gatingSequences);</div><div class="line">    &#125;</div><div class="line">    //原子删除需跟踪的前置消费者seq</div><div class="line">    public boolean removeGatingSequence(Sequence sequence) &#123;</div><div class="line">        return SequenceGroups.removeSequence(this, SEQUENCE_UPDATER, sequence);</div><div class="line">    &#125;</div><div class="line">    //获得前置消费者中消费最慢的seq</div><div class="line">    public long getMinimumSequence() &#123;</div><div class="line">        return Util.getMinimumSequence(this.gatingSequences, this.cursor.get());</div><div class="line">    &#125;</div><div class="line">    //生成消费者屏障，指定前置消费者seq</div><div class="line">    public SequenceBarrier newBarrier(Sequence... sequencesToTrack) &#123;</div><div class="line">        return new ProcessingSequenceBarrier(this, this.waitStrategy, this.cursor, sequencesToTrack);</div><div class="line">    &#125;</div><div class="line">    //不建议使用</div><div class="line">    public &lt;T&gt; EventPoller&lt;T&gt; newPoller(DataProvider&lt;T&gt; dataProvider, Sequence... gatingSequences) &#123;</div><div class="line">        return EventPoller.newInstance(dataProvider, this, new Sequence(), this.cursor, gatingSequences);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;AbstractSequencer&#123;waitStrategy=&quot; + this.waitStrategy + &quot;, cursor=&quot; + this.cursor + &quot;, gatingSequences=&quot; + Arrays.toString(this.gatingSequences) + &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="SingleProducerSequencer"><a href="#SingleProducerSequencer" class="headerlink" title="SingleProducerSequencer"></a>SingleProducerSequencer</h3><p>单线程写数据时使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line">public final class SingleProducerSequencer extends SingleProducerSequencerFields &#123;</div><div class="line">    protected long p1;//缓存行填充</div><div class="line">    protected long p2;</div><div class="line">    protected long p3;</div><div class="line">    protected long p4;</div><div class="line">    protected long p5;</div><div class="line">    protected long p6;</div><div class="line">    protected long p7;</div><div class="line"></div><div class="line">    public SingleProducerSequencer(int bufferSize, WaitStrategy waitStrategy) &#123;</div><div class="line">        super(bufferSize, waitStrategy);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean hasAvailableCapacity(int requiredCapacity) &#123;</div><div class="line">        return this.hasAvailableCapacity(requiredCapacity, false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private boolean hasAvailableCapacity(int requiredCapacity, boolean doStore) &#123;</div><div class="line">        long nextValue = this.nextValue;//上次请求成功的seq</div><div class="line">        //覆盖点：请求的个数+当前位置，超过一圈时，减去bufferSize=需要覆盖的上一圈位置</div><div class="line">        long wrapPoint = nextValue + (long)requiredCapacity - (long)this.bufferSize;</div><div class="line">        long cachedGatingSequence = this.cachedValue;//上次请求时，缓存记录的最慢消费者seq，只有在覆盖点要覆盖他时，才再次计算，计算完后，再次判断是否覆盖</div><div class="line">        //覆盖了消费者未消费的位置</div><div class="line">        if(wrapPoint &gt; cachedGatingSequence || cachedGatingSequence &gt; nextValue) &#123;</div><div class="line">            if(doStore) &#123;//是否要写事件</div><div class="line">                this.cursor.setVolatile(nextValue);//更新生产者cursor=上次请求成功的seq，其他线程立即看到变更</div><div class="line">            &#125;</div><div class="line">            //获得最慢消费者的seq</div><div class="line">            long minSequence = Util.getMinimumSequence(this.gatingSequences, nextValue);</div><div class="line">            this.cachedValue = minSequence;</div><div class="line">            if(wrapPoint &gt; minSequence) &#123;</div><div class="line">                return false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long next() &#123;</div><div class="line">        return this.next(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long next(int n) &#123;//请求几个位置</div><div class="line">        if(n &lt; 1) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;n must be &gt; 0&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            long nextValue = this.nextValue;//上次next()成功的seq</div><div class="line">            long nextSequence = nextValue + (long)n;//本次请求到的seq</div><div class="line">            long wrapPoint = nextSequence - (long)this.bufferSize;//覆盖点</div><div class="line">            long cachedGatingSequence = this.cachedValue;//上次请求时，缓存记录的最慢消费者seq，只有在覆盖点要覆盖他时，才再次计算，计算完后，再次判断是否覆盖</div><div class="line">            if(wrapPoint &gt; cachedGatingSequence || cachedGatingSequence &gt; nextValue) &#123;</div><div class="line">                this.cursor.setVolatile(nextValue);//设置cursor=上次请求成功的seq，其他线程立即看到变更</div><div class="line"></div><div class="line">                long minSequence;</div><div class="line">                while(wrapPoint &gt; (minSequence = Util.getMinimumSequence(this.gatingSequences, nextValue))) &#123;</div><div class="line">                    this.waitStrategy.signalAllWhenBlocking();</div><div class="line">                    LockSupport.parkNanos(1L);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                this.cachedValue = minSequence;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            this.nextValue = nextSequence;//更新生产到的seq</div><div class="line">            return nextSequence;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long tryNext() throws InsufficientCapacityException &#123;</div><div class="line">        return this.tryNext(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long tryNext(int n) throws InsufficientCapacityException &#123;</div><div class="line">        if(n &lt; 1) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;n must be &gt; 0&quot;);</div><div class="line">        &#125; else if(!this.hasAvailableCapacity(n, true)) &#123;</div><div class="line">            throw InsufficientCapacityException.INSTANCE;</div><div class="line">        &#125; else &#123;</div><div class="line">            long nextSequence = this.nextValue += (long)n;</div><div class="line">            return nextSequence;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long remainingCapacity() &#123;</div><div class="line">        long nextValue = this.nextValue;</div><div class="line">        long consumed = Util.getMinimumSequence(this.gatingSequences, nextValue);</div><div class="line">        return (long)this.getBufferSize() - (nextValue - consumed);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void claim(long sequence) &#123;</div><div class="line">        this.nextValue = sequence;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publish(long sequence) &#123;</div><div class="line">        this.cursor.set(sequence);//set方法不保证其他线程立即看到变更</div><div class="line">        this.waitStrategy.signalAllWhenBlocking();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publish(long lo, long hi) &#123;</div><div class="line">        this.publish(hi);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean isAvailable(long sequence) &#123;</div><div class="line">        return sequence &lt;= this.cursor.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getHighestPublishedSequence(long lowerBound, long availableSequence) &#123;</div><div class="line">        return availableSequence;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MultiProducerSequencer"><a href="#MultiProducerSequencer" class="headerlink" title="MultiProducerSequencer"></a>MultiProducerSequencer</h3><p>多线程写数据时使用，与单线程不同处：</p>
<ol>
<li><p>由于是多线程，需对共享变量使用原子操作</p>
<ul>
<li>next()时，未覆盖消费者seq时，尝试set Cursor，使用原子操作：cursor.compareAndSet(current, next)</li>
<li>如果失败，获得当前cursor位置，使用原子操作：current = this.cursor.get();计算覆盖点</li>
<li>获得cachedGatingSequence，使用原子操作：this.gatingSequenceCache.get();</li>
<li>设置cachedGatingSequence，使用原子操作： this.gatingSequenceCache.set(Util.getMinimumSequence(this.gatingSequences, current));</li>
</ul>
</li>
<li>新增int[] availableBuffer记录ringbuffer的槽位是否已写入事件，作为map使用，key=槽位内存地址，value=圈数，如果请求的seq对应圈数和int[]存的一样，则表示已写入事件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line">public final class MultiProducerSequencer extends AbstractSequencer &#123;</div><div class="line">    private static final Unsafe UNSAFE = Util.getUnsafe();</div><div class="line">    private static final long BASE;//数组第一个元素的偏移量（内存位置）</div><div class="line">    private static final long SCALE;//数组每个元素大小</div><div class="line">    private final Sequence gatingSequenceCache = new Sequence(-1L);//最慢消费者seq缓存，不是每次都计算,只有覆盖点&gt;最慢消费者seq时，再次请求计算最新的最慢消费者seq</div><div class="line">    private final int[] availableBuffer;</div><div class="line">    private final int indexMask;//bufferSize-1,用于取模求圈数</div><div class="line">    private final int indexShift;//</div><div class="line"></div><div class="line">    public MultiProducerSequencer(int bufferSize, WaitStrategy waitStrategy) &#123;</div><div class="line">        super(bufferSize, waitStrategy);</div><div class="line">        this.availableBuffer = new int[bufferSize];</div><div class="line">        this.indexMask = bufferSize - 1;</div><div class="line">        this.indexShift = Util.log2(bufferSize);//8-&gt;3,为了后面&gt;&gt;&gt;运算，m&gt;&gt;&gt;n = m除以2的n次方</div><div class="line">        this.initialiseAvailableBuffer();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean hasAvailableCapacity(int requiredCapacity) &#123;</div><div class="line">        return this.hasAvailableCapacity(this.gatingSequences, requiredCapacity, this.cursor.get());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private boolean hasAvailableCapacity(Sequence[] gatingSequences, int requiredCapacity, long cursorValue) &#123;</div><div class="line">        //覆盖点</div><div class="line">        long wrapPoint = cursorValue + (long)requiredCapacity - (long)this.bufferSize;</div><div class="line">        //最慢消费者的消费到的seq</div><div class="line">        long cachedGatingSequence = this.gatingSequenceCache.get();</div><div class="line">        //覆盖点过了最慢消费者的seq，</div><div class="line">        或者cursorValue=Long.maxValue+1位负数，最慢消费者的seq大于cursorValue（不知是否理解有误）</div><div class="line">        if(wrapPoint &gt; cachedGatingSequence || cachedGatingSequence &gt; cursorValue) &#123;</div><div class="line">            //重新计算获得最慢消费者的seq</div><div class="line">            long minSequence = Util.getMinimumSequence(gatingSequences, cursorValue);</div><div class="line">            this.gatingSequenceCache.set(minSequence);</div><div class="line">            //如果仍然覆盖，则返回false</div><div class="line">            if(wrapPoint &gt; minSequence) &#123;</div><div class="line">                return false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void claim(long sequence) &#123;</div><div class="line">        this.cursor.set(sequence);</div><div class="line">    &#125;</div><div class="line">    //阻塞获取可生产填充的下一seq</div><div class="line">    public long next() &#123;</div><div class="line">        return this.next(1);</div><div class="line">    &#125;</div><div class="line">    //阻塞获取可生产填充的下seq</div><div class="line">    public long next(int n) &#123;</div><div class="line">        if(n &lt; 1) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;n must be &gt; 0&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            long current;</div><div class="line">            long next;</div><div class="line">            do &#123;</div><div class="line">                while(true) &#123;</div><div class="line">                    current = this.cursor.get();</div><div class="line">                    next = current + (long)n;</div><div class="line">                    long wrapPoint = next - (long)this.bufferSize;</div><div class="line">                    long cachedGatingSequence = this.gatingSequenceCache.get();</div><div class="line">                    if(wrapPoint &lt;= cachedGatingSequence &amp;&amp; cachedGatingSequence &lt;= current) &#123;</div><div class="line">                        break;//不覆盖时，退出循环</div><div class="line">                    &#125;</div><div class="line">                    //重新计算</div><div class="line">                    long gatingSequence = Util.getMinimumSequence(this.gatingSequences, current);</div><div class="line">                    if(wrapPoint &gt; gatingSequence) &#123;//如果仍然覆盖，则唤醒消费者进行消费，生产者阻塞</div><div class="line">                        this.waitStrategy.signalAllWhenBlocking();</div><div class="line">                        LockSupport.parkNanos(1L);</div><div class="line">                    &#125; else &#123;否则更新最慢消费者的seq，进行下一循环，重新判断（可能是cursor已经变了）</div><div class="line">                        this.gatingSequenceCache.set(gatingSequence);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; while(!this.cursor.compareAndSet(current, next));//不覆盖时，尝试设置cursor为next失败</div><div class="line"></div><div class="line">            return next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //不阻塞，获取失败，抛异常</div><div class="line">    public long tryNext() throws InsufficientCapacityException &#123;</div><div class="line">        return this.tryNext(1);</div><div class="line">    &#125;</div><div class="line">    //不阻塞，获取失败，抛异常</div><div class="line">    public long tryNext(int n) throws InsufficientCapacityException &#123;</div><div class="line">        if(n &lt; 1) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;n must be &gt; 0&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            long current;</div><div class="line">            long next;</div><div class="line">            do &#123;</div><div class="line">                current = this.cursor.get();</div><div class="line">                next = current + (long)n;</div><div class="line">                if(!this.hasAvailableCapacity(this.gatingSequences, n, current)) &#123;</div><div class="line">                    throw InsufficientCapacityException.INSTANCE;</div><div class="line">                &#125;</div><div class="line">            &#125; while(!this.cursor.compareAndSet(current, next));</div><div class="line"></div><div class="line">            return next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long remainingCapacity() &#123;</div><div class="line">        long consumed = Util.getMinimumSequence(this.gatingSequences, this.cursor.get());</div><div class="line">        long produced = this.cursor.get();</div><div class="line">        return (long)this.getBufferSize() - (produced - consumed);</div><div class="line">    &#125;</div><div class="line">    //初始化int[]值为-1，代表圈数</div><div class="line">    private void initialiseAvailableBuffer() &#123;</div><div class="line">        for(int i = this.availableBuffer.length - 1; i != 0; --i) &#123;</div><div class="line">            this.setAvailableBufferValue(i, -1);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        this.setAvailableBufferValue(0, -1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publish(long sequence) &#123;</div><div class="line">        this.setAvailable(sequence);//记录seq所在槽的圈数</div><div class="line">        this.waitStrategy.signalAllWhenBlocking();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publish(long lo, long hi) &#123;</div><div class="line">        for(long l = lo; l &lt;= hi; ++l) &#123;</div><div class="line">            this.setAvailable(l);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        this.waitStrategy.signalAllWhenBlocking();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void setAvailable(long sequence) &#123;</div><div class="line">        this.setAvailableBufferValue(this.calculateIndex(sequence), this.calculateAvailabilityFlag(sequence));</div><div class="line">    &#125;</div><div class="line">    //按内存地址位置指定int[]元素的值，值为圈数</div><div class="line">    index：槽位，flag：圈数</div><div class="line">    private void setAvailableBufferValue(int index, int flag) &#123;</div><div class="line">        //计算槽位对应的内存地址</div><div class="line">        long bufferAddress = (long)index * SCALE + BASE; </div><div class="line">        //设置availableBuffer中偏移量（内存地址）为bufferAddress的值</div><div class="line">        UNSAFE.putOrderedInt(this.availableBuffer, bufferAddress, flag);</div><div class="line">    &#125;</div><div class="line">    //是否可用：seq计算出的圈数是否已被设置到availableBuffer</div><div class="line">    public boolean isAvailable(long sequence) &#123;</div><div class="line">        int index = this.calculateIndex(sequence);</div><div class="line">        int flag = this.calculateAvailabilityFlag(sequence);</div><div class="line">        long bufferAddress = (long)index * SCALE + BASE;</div><div class="line">        return UNSAFE.getIntVolatile(this.availableBuffer, bufferAddress) == flag;</div><div class="line">    &#125;</div><div class="line">    //lowerBound 到 availableSequence之间 最大可用seq</div><div class="line">    public long getHighestPublishedSequence(long lowerBound, long availableSequence) &#123;</div><div class="line">        for(long sequence = lowerBound; sequence &lt;= availableSequence; ++sequence) &#123;</div><div class="line">            if(!this.isAvailable(sequence)) &#123;</div><div class="line">                return sequence - 1L;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return availableSequence;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private int calculateAvailabilityFlag(long sequence) &#123;</div><div class="line">        return (int)(sequence &gt;&gt;&gt; this.indexShift);//圈数</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private int calculateIndex(long sequence) &#123;</div><div class="line">        return (int)sequence &amp; this.indexMask;//槽位</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static &#123;</div><div class="line">        BASE = (long)UNSAFE.arrayBaseOffset(int[].class);//数组第一个元素的偏移量（内存位置）</div><div class="line">        SCALE = (long)UNSAFE.arrayIndexScale(int[].class);//数组一个元素的大小</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="SequenceBarrier"><a href="#SequenceBarrier" class="headerlink" title="SequenceBarrier"></a>SequenceBarrier</h2><p>一个消费者组对应一个barrier</p>
<p>1、waitFor获得最大可用seq（前置消费者已消费，且已写入事件）</p>
<ul>
<li>实际调用等待策略的waitFor()，获得前置消费者消费到的位置，availableSequence = dependentSequence.get()，可能存在批量消费的情况，所以availableSequence 可能会大于请求的seq</li>
<li>然后调用sequencer.getHighestPublishedSequence(sequence, availableSequence);获得最大已写入事件的seq</li>
</ul>
<p>2、alert唤醒阻塞的消费者,实际调用等待策略的signalAllWhenBlocking()</p>
<h3 id="ProcessingSequenceBarrier"><a href="#ProcessingSequenceBarrier" class="headerlink" title="ProcessingSequenceBarrier"></a>ProcessingSequenceBarrier</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">final class ProcessingSequenceBarrier implements SequenceBarrier&#123;</div><div class="line">    //等待策略。  </div><div class="line">    private final WaitStrategy waitStrategy;  </div><div class="line">    前置消费者的Sequence，如果没有，则等于生产者的Sequence  </div><div class="line">    private final Sequence dependentSequence; </div><div class="line">    是否已通知</div><div class="line">    private volatile boolean alerted = false;  </div><div class="line">    生产者的Sequence</div><div class="line">    private final Sequence cursorSequence;  </div><div class="line">    生产者seq管理器，获得最大可用long，MultiProducerSequencer 或 SingleProducerSequencer</div><div class="line">    private final Sequencer sequencer;  </div><div class="line">    public ProcessingSequenceBarrier(final Sequencer sequencer,  </div><div class="line">                                     final WaitStrategy waitStrategy,  </div><div class="line">                                     final Sequence cursorSequence,  </div><div class="line">                                     final Sequence[] dependentSequences)&#123;  </div><div class="line">        this.sequencer = sequencer;  </div><div class="line">        this.waitStrategy = waitStrategy;  </div><div class="line">        this.cursorSequence = cursorSequence;  </div><div class="line">        if (0 == dependentSequences.length)&#123;  </div><div class="line">            dependentSequence = cursorSequence;  </div><div class="line">        &#125;else&#123;  </div><div class="line">            dependentSequence = new FixedSequenceGroup(dependentSequences);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public long waitFor(final long sequence)  </div><div class="line">        throws AlertException, InterruptedException, TimeoutException&#123;  </div><div class="line">        //先检测是否已通知生产者，通知过则发异常</div><div class="line">        checkAlert();  </div><div class="line">        //然后根据等待策略来等待可用的序列值，消费者批量消费到的seq，可能未发布事件</div><div class="line">        long availableSequence = waitStrategy.waitFor(sequence, cursorSequence, dependentSequence, this);  </div><div class="line">        if (availableSequence &lt; sequence)&#123;  </div><div class="line">            return availableSequence; //如果可用的序列值小于请求的序列，那么直接返回可用的序列。  </div><div class="line">        &#125;  </div><div class="line">        //否则，返回能使用（已发布事件）的最大的序列值，</div><div class="line">        return sequencer.getHighestPublishedSequence(sequence, availableSequence);  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public long getCursor()&#123;  </div><div class="line">        return dependentSequence.get();  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public boolean isAlerted()&#123;  </div><div class="line">        return alerted;  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public void alert()&#123;  </div><div class="line">        alerted = true; //设置通知标记  </div><div class="line">        waitStrategy.signalAllWhenBlocking();//如果有线程以阻塞的方式等待序列，将其唤醒。  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public void clearAlert()&#123;  </div><div class="line">        alerted = false;  </div><div class="line">    &#125;  </div><div class="line">    @Override  </div><div class="line">    public void checkAlert() throws AlertException&#123;  </div><div class="line">        if (alerted)&#123;  </div><div class="line">            throw AlertException.INSTANCE;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BlockingWaitStrategy"><a href="#BlockingWaitStrategy" class="headerlink" title="BlockingWaitStrategy"></a>BlockingWaitStrategy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">public final class BlockingWaitStrategy implements WaitStrategy &#123;</div><div class="line">    private final Lock lock = new ReentrantLock();</div><div class="line">    private final Condition processorNotifyCondition;</div><div class="line"></div><div class="line">    public BlockingWaitStrategy() &#123;</div><div class="line">        this.processorNotifyCondition = this.lock.newCondition();</div><div class="line">    &#125;</div><div class="line">    //等待最大可用序列号</div><div class="line">    public long waitFor(long sequence, Sequence cursorSequence, Sequence dependentSequence, SequenceBarrier barrier) throws AlertException, InterruptedException &#123;</div><div class="line">        if(cursorSequence.get() &lt; sequence) &#123;请求的seq&gt;生产者seq：进入可重入锁并等待 </div><div class="line">            this.lock.lock();</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                while(cursorSequence.get() &lt; sequence) &#123;</div><div class="line">                    barrier.checkAlert();//循环检查是否请求的seq&gt;生产者seq，是的话检查是否已解除屏障，是则抛异常，终止循环，否则等待。</div><div class="line">                    this.processorNotifyCondition.await();</div><div class="line">                &#125;</div><div class="line">            &#125; finally &#123;</div><div class="line">                this.lock.unlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        long availableSequence;</div><div class="line">        //当请求的seq&lt;=生产者seq，检查是否请求的seq&gt;前置消费者消费到的seq,是的话自旋（并循环检查是否有其他线程已唤醒消费者，是的话则抛异常,等同于是否已解除屏障，这块不知道理解对否）</div><div class="line">        while((availableSequence = dependentSequence.get()) &lt; sequence) &#123;</div><div class="line">            barrier.checkAlert();</div><div class="line">        &#125;</div><div class="line">        return availableSequence;</div><div class="line">    &#125;</div><div class="line">    //通知所有等待的消费者</div><div class="line">    public void signalAllWhenBlocking() &#123;</div><div class="line">        this.lock.lock();</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            this.processorNotifyCondition.signalAll();</div><div class="line">        &#125; finally &#123;</div><div class="line">            this.lock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;BlockingWaitStrategy&#123;processorNotifyCondition=&quot; + this.processorNotifyCondition + &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="RingBuffer"><a href="#RingBuffer" class="headerlink" title="RingBuffer"></a>RingBuffer</h2><ol>
<li>RingBuffer对象做了缓存行填充，前后各填充了56个字节，</li>
<li>entries[]本身也根据引用大小进行了填充，数组前后各增加了128字节的数组对象，每个对象引用大小=4或8（大小与32位与64位系统及指针压缩有关），则前后各填充32或16个空数组位</li>
<li>所以实际的数组长度比bufferSize要大。所以根据序列从entries中取元素的方法elementAt内部做了一些调整，而不是单纯取模，seq内存地址为=槽位（seq&amp;（buffersize-1））*对象大小+起始偏移量</li>
<li>RingBuffer对象的创建是静态方法，需指定Sequencer类型，传递EventFactory</li>
<li>序列管理相关的方法实际是通过调用sequencer的相关方法实现的，如next(),addGatingSequences()</li>
<li>可发布EventTranslator：publishEvent(EventTranslator)，也可先获得next seq，再获得预初始化的Event对象，修改Event对象，再发布seq。</li>
<li>SingleProducer模式下，使用多线程发布，会有数据被覆盖的情况，所以需根据情况选择合理的模式</li>
<li>重要属性及方法说明：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public final class RingBuffer&lt;E&gt; extends RingBufferFields&lt;E&gt; implements Cursored, EventSequencer&lt;E&gt;, EventSink&lt;E&gt; &#123;</div><div class="line"></div><div class="line">  private final long indexMask = (long)(this.bufferSize - 1);//用于计算seq槽位=seq&amp;indexMask</div><div class="line"></div><div class="line">  private final Object[] entries;//事件</div><div class="line"></div><div class="line">  protected final int bufferSize;//大小</div><div class="line"></div><div class="line">  protected final Sequencer sequencer; //序列管理</div><div class="line"></div><div class="line">  RingBuffer(EventFactory&lt;E&gt; eventFactory, Sequencer sequencer)//私有构造方法</div><div class="line"></div><div class="line">  public static &lt;E&gt; RingBuffer&lt;E&gt; createMultiProducer(EventFactory&lt;E&gt; factory, int bufferSize, WaitStrategy waitStrategy)//创建多生产者的ringbuffer</div><div class="line"></div><div class="line">  public static &lt;E&gt; RingBuffer&lt;E&gt; createSingleProducer(EventFactory&lt;E&gt; factory, int bufferSize, WaitStrategy waitStrategy)//创建单一生产者的ringbuffer</div><div class="line"></div><div class="line">  public static &lt;E&gt; RingBuffer&lt;E&gt; create(ProducerType producerType, EventFactory&lt;E&gt; factory, int bufferSize, WaitStrategy waitStrategy) //根据producerType创建ringbuffer</div><div class="line"></div><div class="line">  //添加gatingSequences</div><div class="line">  public void addGatingSequences(Sequence... gatingSequences) &#123;</div><div class="line">		this.sequencer.addGatingSequences(gatingSequences);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>RingBufferFields<e> 填充</e></li>
<li>Cursored, 获得当前指针序号</li>
<li><p>EventSequencer<e>, 序号管理</e></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1、DataProvider&lt;T&gt;提供获取Event对象的方法: T get(long var1);</div><div class="line">2、Sequenced序号管理: next(long var1),tryNext(long var1)</div><div class="line">public interface EventSequencer&lt;T&gt; extends DataProvider&lt;T&gt;, Sequenced</div></pre></td></tr></table></figure>
</li>
<li><p>EventSink<e> 事件发布</e></p>
</li>
</ul>
<h2 id="EventProcessor"><a href="#EventProcessor" class="headerlink" title="EventProcessor"></a>EventProcessor</h2><ul>
<li>一个线程EventProcessor 一个线程，对应一个EventHandler，</li>
<li>包含一个Sequence，记录当前消费到的seq，这个seq会被加入到Sequencer作为gatingSequence</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public interface EventProcessor extends Runnable&#123;  </div><div class="line">    /** </div><div class="line">     * 获取一个事件处理器使用的序列引用。 </div><div class="line">     */  </div><div class="line">    Sequence getSequence();  </div><div class="line">    void halt();  </div><div class="line">    boolean isRunning();  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BatchEventProcessor"><a href="#BatchEventProcessor" class="headerlink" title="BatchEventProcessor"></a>BatchEventProcessor</h3><ul>
<li>每个BatchEventProcessor都会处理一遍RingBuffer中的事件</li>
<li>默认异常了，调用默认的exceptionHandler仍继续处理，默认exceptionHandler直接抛了异常出去，消费者会阻塞，可能会影响业务，需自定义异常。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">public final class BatchEventProcessor&lt;T&gt; implements EventProcessor &#123;</div><div class="line">    private final AtomicBoolean running = new AtomicBoolean(false);//运行状态</div><div class="line">    private ExceptionHandler&lt;? super T&gt; exceptionHandler = new FatalExceptionHandler();</div><div class="line">    private final DataProvider&lt;T&gt; dataProvider;</div><div class="line">    private final SequenceBarrier sequenceBarrier;</div><div class="line">    private final EventHandler&lt;? super T&gt; eventHandler;</div><div class="line">    private final Sequence sequence = new Sequence(-1L);//当前处理到的seq</div><div class="line">    private final TimeoutHandler timeoutHandler;</div><div class="line">    private final BatchStartAware batchStartAware;</div><div class="line">    </div><div class="line">    public BatchEventProcessor(DataProvider&lt;T&gt; dataProvider, SequenceBarrier sequenceBarrier, EventHandler&lt;? super T&gt; eventHandler) &#123;</div><div class="line">        this.dataProvider = dataProvider;</div><div class="line">        this.sequenceBarrier = sequenceBarrier;</div><div class="line">        this.eventHandler = eventHandler;</div><div class="line">        if(eventHandler instanceof SequenceReportingEventHandler) &#123;</div><div class="line">            ((SequenceReportingEventHandler)eventHandler).setSequenceCallback(this.sequence);</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">        this.batchStartAware = eventHandler instanceof BatchStartAware?(BatchStartAware)eventHandler:null;</div><div class="line">        this.timeoutHandler = eventHandler instanceof TimeoutHandler?(TimeoutHandler)eventHandler:null;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public Sequence getSequence() &#123;</div><div class="line">        return this.sequence;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public void halt() &#123;</div><div class="line">        this.running.set(false);</div><div class="line">        this.sequenceBarrier.alert();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public boolean isRunning() &#123;</div><div class="line">        return this.running.get();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public void setExceptionHandler(ExceptionHandler&lt;? super T&gt; exceptionHandler) &#123;</div><div class="line">        if(null == exceptionHandler) &#123;</div><div class="line">            throw new NullPointerException();</div><div class="line">        &#125; else &#123;</div><div class="line">            this.exceptionHandler = exceptionHandler;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public void run() &#123;</div><div class="line">        if(!this.running.compareAndSet(false, true)) &#123;//原子设置运行状态为true，如果已经为true则正在运行，否则启动运行。</div><div class="line">            throw new IllegalStateException(&quot;Thread is already running&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            this.sequenceBarrier.clearAlert();//清除消费者屏障</div><div class="line">            this.notifyStart();//如果eventHandler继承LifecycleAware，通知调用onStart方法</div><div class="line">            Object event = null;</div><div class="line">            long nextSequence = this.sequence.get() + 1L;//当前处理到的seq+1</div><div class="line">    </div><div class="line">            try &#123;</div><div class="line">                while(true) &#123;</div><div class="line">                    try &#123;</div><div class="line">                        long ex = this.sequenceBarrier.waitFor(nextSequence);//使用屏障获得最大可用seq</div><div class="line">                        if(this.batchStartAware != null) &#123;//批量启动通知</div><div class="line">                            this.batchStartAware.onBatchStart(ex - nextSequence + 1L);</div><div class="line">                        &#125;</div><div class="line">    </div><div class="line">                        while(nextSequence &lt;= ex) &#123;如果请求的seq小于最大可用seq，则遍历处理这些可用seq</div><div class="line">                            event = this.dataProvider.get(nextSequence);</div><div class="line">                            this.eventHandler.onEvent(event, nextSequence, nextSequence == ex);</div><div class="line">                            ++nextSequence;</div><div class="line">                        &#125;</div><div class="line">    </div><div class="line">                        this.sequence.set(ex);//设置处理到的seq为最大可用seq</div><div class="line">                    &#125; catch (TimeoutException var11) &#123;</div><div class="line">                        this.notifyTimeout(this.sequence.get());</div><div class="line">                    &#125; catch (AlertException var12) &#123;</div><div class="line">                        if(!this.running.get()) &#123;//执行halt()后，running=false</div><div class="line">                            return;//终止线程</div><div class="line">                        &#125;</div><div class="line">                    &#125; catch (Throwable var13) &#123;//异常仍然继续处理</div><div class="line">                        this.exceptionHandler.handleEventException(var13, nextSequence, event);</div><div class="line">                        this.sequence.set(nextSequence);</div><div class="line">                        ++nextSequence;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; finally &#123;</div><div class="line">                this.notifyShutdown();//eventhandler如果实现了LifecycleAware，通知调用onShutdown方法</div><div class="line">                this.running.set(false);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    private void notifyTimeout(long availableSequence) &#123;</div><div class="line">        try &#123;</div><div class="line">            if(this.timeoutHandler != null) &#123;</div><div class="line">                this.timeoutHandler.onTimeout(availableSequence);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (Throwable var4) &#123;</div><div class="line">            this.exceptionHandler.handleEventException(var4, availableSequence, (Object)null);</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    private void notifyStart() &#123;</div><div class="line">        if(this.eventHandler instanceof LifecycleAware) &#123;</div><div class="line">            try &#123;</div><div class="line">                ((LifecycleAware)this.eventHandler).onStart();</div><div class="line">            &#125; catch (Throwable var2) &#123;</div><div class="line">                this.exceptionHandler.handleOnStartException(var2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    private void notifyShutdown() &#123;</div><div class="line">        if(this.eventHandler instanceof LifecycleAware) &#123;</div><div class="line">            try &#123;</div><div class="line">                ((LifecycleAware)this.eventHandler).onShutdown();</div><div class="line">            &#125; catch (Throwable var2) &#123;</div><div class="line">                this.exceptionHandler.handleOnShutdownException(var2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="EventHandler"><a href="#EventHandler" class="headerlink" title="EventHandler"></a>EventHandler</h4><p>具体事件处理逻辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public interface EventHandler&lt;T&gt;&#123;</div><div class="line">	void onEvent(T event, long sequence, boolean endOfBatch) throws Exception; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WorkProcessor"><a href="#WorkProcessor" class="headerlink" title="WorkProcessor"></a>WorkProcessor</h3><p>多个同类的workProcessor线程，竞争消费RingBuffer（通过workSequence.CAS），一个线程消费过的，其他线程不再消费</p>
<ul>
<li><p>传递workHandler，workSequence（多线程共享上一次被处理的事件的seq，各线程尝试cas设置为workSequence+1，如果成功则表示改线程获得可处理的seq）</p>
</li>
<li><p>持有eventReleaser </p>
</li>
<li><p>halt()方法终止线程，</p>
<ol>
<li>halt()方法会调用barrier.alert()-设置alert=true</li>
<li>run方法中barrier.waitFor()会调用checkAlert(),如果alert=ture会抛AlertException异常</li>
<li>run()捕获AlertException异常，终止线程</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line">public final class WorkProcessor&lt;T&gt; implements EventProcessor &#123;</div><div class="line"></div><div class="line">    private final AtomicBoolean running = new AtomicBoolean(false);</div><div class="line">    private final Sequence sequence = new Sequence(-1L);当前处理到的seq</div><div class="line">    private final RingBuffer&lt;T&gt; ringBuffer;</div><div class="line">    private final SequenceBarrier sequenceBarrier;</div><div class="line">    private final WorkHandler&lt;? super T&gt; workHandler;</div><div class="line">    private final ExceptionHandler&lt;? super T&gt; exceptionHandler;</div><div class="line">    private final Sequence workSequence;//多线程共享，上一次处理的事件的seq</div><div class="line">    private final EventReleaser eventReleaser = new EventReleaser() &#123;</div><div class="line">    public void release() &#123;</div><div class="line">        WorkProcessor.this.sequence.set(9223372036854775807L);</div><div class="line">    &#125;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	private final TimeoutHandler timeoutHandler;</div><div class="line">	</div><div class="line">	public WorkProcessor(RingBuffer&lt;T&gt; ringBuffer, SequenceBarrier sequenceBarrier, WorkHandler&lt;? super T&gt; workHandler, ExceptionHandler&lt;? super T&gt; exceptionHandler, Sequence workSequence) &#123;</div><div class="line">	</div><div class="line">	    this.ringBuffer = ringBuffer;</div><div class="line">	    this.sequenceBarrier = sequenceBarrier;</div><div class="line">	    this.workHandler = workHandler;</div><div class="line">	    this.exceptionHandler = exceptionHandler;</div><div class="line">	    this.workSequence = workSequence;</div><div class="line">	    if(this.workHandler instanceof EventReleaseAware) &#123;</div><div class="line">	        ((EventReleaseAware)this.workHandler).setEventReleaser(this.eventReleaser);</div><div class="line">	    &#125;</div><div class="line">	    </div><div class="line">	    this.timeoutHandler = workHandler instanceof TimeoutHandler?(TimeoutHandler)workHandler:null;</div><div class="line">	</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public Sequence getSequence() &#123;</div><div class="line">	    return this.sequence;	</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void halt() &#123;	</div><div class="line">	    this.running.set(false);</div><div class="line">	    this.sequenceBarrier.alert();//通知阻塞等待的消费者，sequenceBarrier.waitFor中checkAlert会抛异常，中断线程</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public boolean isRunning() &#123;</div><div class="line">	    return this.running.get();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void run() &#123;</div><div class="line">	    if(!this.running.compareAndSet(false, true)) &#123;</div><div class="line">	        throw new IllegalStateException(&quot;Thread is already running&quot;);</div><div class="line">	    &#125; else &#123;</div><div class="line">	        this.sequenceBarrier.clearAlert();</div><div class="line">	        this.notifyStart();</div><div class="line">	        boolean processedSequence = true;</div><div class="line">	        long cachedAvailableSequence = -9223372036854775808L;</div><div class="line">	        long nextSequence = this.sequence.get();</div><div class="line">	        Object event = null;</div><div class="line">	    </div><div class="line">	        while(true) &#123;</div><div class="line">	            while(true) &#123;</div><div class="line">	                try &#123;</div><div class="line">	                    if(processedSequence) &#123;//上一事件是否处理完成，是的话，进入新事件处理流程</div><div class="line">	                        processedSequence = false;</div><div class="line">	    </div><div class="line">	                        do &#123;</div><div class="line">	                            nextSequence = this.workSequence.get() + 1L;//获得下一要处理的seq</div><div class="line">	                            this.sequence.set(nextSequence - 1L);//更新当前已处理到的seq为请求的seq-1</div><div class="line">	                        &#125; while(!this.workSequence.compareAndSet(nextSequence - 1L, nextSequence));//尝试cas下一workSequence = workSequence+1直到成功</div><div class="line">	                    &#125;</div><div class="line"></div><div class="line">	                    if(cachedAvailableSequence &gt;= nextSequence) &#123;请求的seq是否小于缓存的最大可用seq，是的话获得请求的事件，进行处理，处理完成后，processedSequence标记为true</div><div class="line">	                        event = this.ringBuffer.get(nextSequence);</div><div class="line">	                        this.workHandler.onEvent(event);</div><div class="line">	                        processedSequence = true;</div><div class="line">	                    &#125; else &#123;//否则，阻塞等待当前可用的最大seq，并更新cache，继续下一循环</div><div class="line">	                        cachedAvailableSequence = this.sequenceBarrier.waitFor(nextSequence);</div><div class="line">	                    &#125;</div><div class="line">	                &#125; catch (TimeoutException var8) &#123;</div><div class="line">	                    this.notifyTimeout(this.sequence.get());</div><div class="line">	                &#125; catch (AlertException var9) &#123;</div><div class="line">	                    if(!this.running.get()) &#123;</div><div class="line">	                        this.notifyShutdown();</div><div class="line">	                        this.running.set(false);</div><div class="line">	                        return;//终止线程</div><div class="line">	                    &#125;</div><div class="line">	                &#125; catch (Throwable var10) &#123;</div><div class="line">	                    this.exceptionHandler.handleEventException(var10, nextSequence, event);</div><div class="line">	                    processedSequence = true;</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	private void notifyTimeout(long availableSequence) &#123;</div><div class="line">	    try &#123;</div><div class="line">	        if(this.timeoutHandler != null) &#123;</div><div class="line">	            this.timeoutHandler.onTimeout(availableSequence);</div><div class="line">	        &#125;</div><div class="line">	    &#125; catch (Throwable var4) &#123;</div><div class="line">	        this.exceptionHandler.handleEventException(var4, availableSequence, (Object)null);</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	private void notifyStart() &#123;</div><div class="line">	    if(this.workHandler instanceof LifecycleAware) &#123;</div><div class="line">	        try &#123;</div><div class="line">	            ((LifecycleAware)this.workHandler).onStart();</div><div class="line">	        &#125; catch (Throwable var2) &#123;</div><div class="line">	            this.exceptionHandler.handleOnStartException(var2);</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	private void notifyShutdown() &#123;</div><div class="line">	    if(this.workHandler instanceof LifecycleAware) &#123;</div><div class="line">	        try &#123;</div><div class="line">	            ((LifecycleAware)this.workHandler).onShutdown();</div><div class="line">	        &#125; catch (Throwable var2) &#123;</div><div class="line">	            this.exceptionHandler.handleOnShutdownException(var2);</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WorkerPool"><a href="#WorkerPool" class="headerlink" title="WorkerPool"></a>WorkerPool</h4><p>多个WorkProcessor&lt;?&gt;[]线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">public final class WorkerPool&lt;T&gt; &#123;</div><div class="line">    private final AtomicBoolean started = new AtomicBoolean(false);//运行状态</div><div class="line">    private final Sequence workSequence = new Sequence(-1L);//多个Processor共用一个处理的seq</div><div class="line">    private final RingBuffer&lt;T&gt; ringBuffer;</div><div class="line">    private final WorkProcessor&lt;?&gt;[] workProcessors;//处理线程组</div><div class="line"></div><div class="line">    public WorkerPool(RingBuffer&lt;T&gt; ringBuffer, SequenceBarrier sequenceBarrier, ExceptionHandler&lt;? super T&gt; exceptionHandler, WorkHandler... workHandlers) &#123;</div><div class="line">        this.ringBuffer = ringBuffer;</div><div class="line">        int numWorkers = workHandlers.length;</div><div class="line">        this.workProcessors = new WorkProcessor[numWorkers];//一个handler一个线程</div><div class="line">        for(int i = 0; i &lt; numWorkers; ++i) &#123;</div><div class="line">            this.workProcessors[i] = new WorkProcessor(ringBuffer, sequenceBarrier, workHandlers[i], exceptionHandler, this.workSequence);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public WorkerPool(EventFactory&lt;T&gt; eventFactory, ExceptionHandler&lt;? super T&gt; exceptionHandler, WorkHandler... workHandlers) &#123;</div><div class="line">        this.ringBuffer = RingBuffer.createMultiProducer(eventFactory, 1024, new BlockingWaitStrategy());</div><div class="line">        SequenceBarrier barrier = this.ringBuffer.newBarrier(new Sequence[0]);</div><div class="line">        int numWorkers = workHandlers.length;</div><div class="line">        this.workProcessors = new WorkProcessor[numWorkers];</div><div class="line">        for(int i = 0; i &lt; numWorkers; ++i) &#123;</div><div class="line">            this.workProcessors[i] = new WorkProcessor(this.ringBuffer, barrier, workHandlers[i], exceptionHandler, this.workSequence);</div><div class="line">        &#125;</div><div class="line">        this.ringBuffer.addGatingSequences(this.getWorkerSequences());//添加消费者seq</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public Sequence[] getWorkerSequences() &#123;//每个Processor消费到的Sequence加上workSequence，共同作为消费者seq</div><div class="line">        Sequence[] sequences = new Sequence[this.workProcessors.length + 1];</div><div class="line">        int i = 0;</div><div class="line">        for(int size = this.workProcessors.length; i &lt; size; ++i) &#123;</div><div class="line">            sequences[i] = this.workProcessors[i].getSequence();</div><div class="line">        &#125;</div><div class="line">        sequences[sequences.length - 1] = this.workSequence;</div><div class="line">        return sequences;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RingBuffer&lt;T&gt; start(Executor executor) &#123;</div><div class="line">        if(!this.started.compareAndSet(false, true)) &#123;//检查是否已启动</div><div class="line">            throw new IllegalStateException(&quot;WorkerPool has already been started and cannot be restarted until halted.&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            long cursor = this.ringBuffer.getCursor();//生产者当前生产到的seq</div><div class="line">            this.workSequence.set(cursor);//从生产者当前生产到的seq开始消费，作为workSeq</div><div class="line">            WorkProcessor[] var4 = this.workProcessors;</div><div class="line">            int var5 = var4.length;</div><div class="line">            for(int var6 = 0; var6 &lt; var5; ++var6) &#123;</div><div class="line">                WorkProcessor processor = var4[var6];</div><div class="line">                processor.getSequence().set(cursor);//遍历processor，设置workSeq</div><div class="line">                executor.execute(processor);//放入线程池</div><div class="line">            &#125;</div><div class="line">            return this.ringBuffer;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void drainAndHalt() &#123;//等待消费者处理完，然后暂停</div><div class="line">        Sequence[] workerSequences = this.getWorkerSequences();//获得消费者消费到的seq</div><div class="line"></div><div class="line">        while(this.ringBuffer.getCursor() &gt; Util.getMinimumSequence(workerSequences)) &#123;</div><div class="line">            Thread.yield();//如果生产者覆盖了消费者未消费的seq，则等待</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WorkProcessor[] var2 = this.workProcessors;</div><div class="line">        int var3 = var2.length;</div><div class="line">        for(int var4 = 0; var4 &lt; var3; ++var4) &#123;</div><div class="line">            WorkProcessor processor = var2[var4];</div><div class="line">            processor.halt();//消费者中断阻塞</div><div class="line">        &#125;</div><div class="line">        this.started.set(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void halt() &#123;</div><div class="line">        WorkProcessor[] var1 = this.workProcessors;</div><div class="line">        int var2 = var1.length;</div><div class="line">        for(int var3 = 0; var3 &lt; var2; ++var3) &#123;</div><div class="line">            WorkProcessor processor = var1[var3];</div><div class="line">            processor.halt();//消费者中断阻塞</div><div class="line">        &#125;</div><div class="line">        this.started.set(false);//停止线程池</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public boolean isRunning() &#123;</div><div class="line">        return this.started.get();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WorkHandler"><a href="#WorkHandler" class="headerlink" title="WorkHandler"></a>WorkHandler</h4><p>具体事件处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public interface WorkHandler&lt;T&gt; &#123;</div><div class="line">	void onEvent(T var1) throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="DSL"><a href="#DSL" class="headerlink" title="DSL"></a>DSL</h1><h2 id="Disruptor"><a href="#Disruptor" class="headerlink" title="Disruptor"></a>Disruptor</h2><ul>
<li><p>Disruptor.handleEventsWith会调用updateGatingSequencesForNextInChain：更新Sequencer监听的消费者链上最后一个消费者组的seqs，同时删除前置消费者的seq，不再监听，修改前置消费者seq不为链上最后消费者seq</p>
</li>
<li><p>EventHandlerGroup.then()方法时间调用的也是Disruptor.handleEventsWith</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div></pre></td><td class="code"><pre><div class="line">public class Disruptor&lt;T&gt; &#123;</div><div class="line">    private final RingBuffer&lt;T&gt; ringBuffer;</div><div class="line">    private final Executor executor;//线程池</div><div class="line">    private final ConsumerRepository&lt;T&gt; consumerRepository;//消费者仓库</div><div class="line">    private final AtomicBoolean started;//是否启动</div><div class="line">    private ExceptionHandler&lt;? super T&gt; exceptionHandler;</div><div class="line"></div><div class="line">    /** @deprecated */</div><div class="line">    @Deprecated</div><div class="line">    public Disruptor(EventFactory&lt;T&gt; eventFactory, int ringBufferSize, Executor executor) &#123;</div><div class="line">        this(RingBuffer.createMultiProducer(eventFactory, ringBufferSize), executor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /** @deprecated */</div><div class="line">    @Deprecated</div><div class="line">    public Disruptor(EventFactory&lt;T&gt; eventFactory, int ringBufferSize, Executor executor, ProducerType producerType, WaitStrategy waitStrategy) &#123;</div><div class="line">        this(RingBuffer.create(producerType, eventFactory, ringBufferSize, waitStrategy), executor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Disruptor(EventFactory&lt;T&gt; eventFactory, int ringBufferSize, ThreadFactory threadFactory) &#123;</div><div class="line">        this(RingBuffer.createMultiProducer(eventFactory, ringBufferSize), new BasicExecutor(threadFactory));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Disruptor(EventFactory&lt;T&gt; eventFactory, int ringBufferSize, ThreadFactory threadFactory, ProducerType producerType, WaitStrategy waitStrategy) &#123;</div><div class="line">        this(RingBuffer.create(producerType, eventFactory, ringBufferSize, waitStrategy), new BasicExecutor(threadFactory));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Disruptor(RingBuffer&lt;T&gt; ringBuffer, Executor executor) &#123;</div><div class="line">        this.consumerRepository = new ConsumerRepository();</div><div class="line">        this.started = new AtomicBoolean(false);</div><div class="line">        this.exceptionHandler = new ExceptionHandlerWrapper();</div><div class="line">        this.ringBuffer = ringBuffer;</div><div class="line">        this.executor = executor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //添加消费者，前置消费者默认为空=生产者cursor</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWith(EventHandler... handlers) &#123;</div><div class="line">        return this.createEventProcessors(new Sequence[0], handlers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //添加消费者，前置消费者默认为空=生产者cursor</div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWith(EventProcessorFactory... eventProcessorFactories) &#123;</div><div class="line">        Sequence[] barrierSequences = new Sequence[0];</div><div class="line">        return this.createEventProcessors(barrierSequences, eventProcessorFactories);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //添加消费者，前置消费者默认为空=生产者cursor</div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWith(EventProcessor... processors) &#123;</div><div class="line">        EventProcessor[] sequences = processors;</div><div class="line">        int i = processors.length;    </div><div class="line">        for(int var4 = 0; var4 &lt; i; ++var4) &#123;</div><div class="line">            EventProcessor processor = sequences[var4];</div><div class="line">            this.consumerRepository.add(processor);</div><div class="line">        &#125;    </div><div class="line">        Sequence[] var6 = new Sequence[processors.length];    </div><div class="line">        for(i = 0; i &lt; processors.length; ++i) &#123;</div><div class="line">            var6[i] = processors[i].getSequence();</div><div class="line">        &#125;    </div><div class="line">        this.ringBuffer.addGatingSequences(var6);</div><div class="line">        return new EventHandlerGroup(this, this.consumerRepository, Util.getSequencesFor(processors));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //创建多线程消费者</div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWithWorkerPool(WorkHandler... workHandlers) &#123;</div><div class="line">        return this.createWorkerPool(new Sequence[0], workHandlers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /** @deprecated */</div><div class="line">    public void handleExceptionsWith(ExceptionHandler&lt;? super T&gt; exceptionHandler) &#123;</div><div class="line">        this.exceptionHandler = exceptionHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setDefaultExceptionHandler(ExceptionHandler&lt;? super T&gt; exceptionHandler) &#123;</div><div class="line">        this.checkNotStarted();</div><div class="line">        if(!(this.exceptionHandler instanceof ExceptionHandlerWrapper)) &#123;</div><div class="line">            throw new IllegalStateException(&quot;setDefaultExceptionHandler can not be used after handleExceptionsWith&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            ((ExceptionHandlerWrapper)this.exceptionHandler).switchTo(exceptionHandler);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ExceptionHandlerSetting&lt;T&gt; handleExceptionsFor(EventHandler&lt;T&gt; eventHandler) &#123;</div><div class="line">        return new ExceptionHandlerSetting(eventHandler, this.consumerRepository);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; after(EventHandler... handlers) &#123;</div><div class="line">        Sequence[] sequences = new Sequence[handlers.length];</div><div class="line">        int i = 0;   </div><div class="line">        for(int handlersLength = handlers.length; i &lt; handlersLength; ++i) &#123;</div><div class="line">            sequences[i] = this.consumerRepository.getSequenceFor(handlers[i]);</div><div class="line">        &#125;</div><div class="line">        return new EventHandlerGroup(this, this.consumerRepository, sequences);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; after(EventProcessor... processors) &#123;</div><div class="line">        EventProcessor[] var2 = processors;</div><div class="line">        int var3 = processors.length;    </div><div class="line">        for(int var4 = 0; var4 &lt; var3; ++var4) &#123;</div><div class="line">            EventProcessor processor = var2[var4];</div><div class="line">            this.consumerRepository.add(processor);</div><div class="line">        &#125;</div><div class="line">        return new EventHandlerGroup(this, this.consumerRepository, Util.getSequencesFor(processors));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void publishEvent(EventTranslator&lt;T&gt; eventTranslator) &#123;</div><div class="line">        this.ringBuffer.publishEvent(eventTranslator);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public &lt;A&gt; void publishEvent(EventTranslatorOneArg&lt;T, A&gt; eventTranslator, A arg) &#123;</div><div class="line">        this.ringBuffer.publishEvent(eventTranslator, arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public &lt;A&gt; void publishEvents(EventTranslatorOneArg&lt;T, A&gt; eventTranslator, A[] arg) &#123;</div><div class="line">        this.ringBuffer.publishEvents(eventTranslator, arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public &lt;A, B&gt; void publishEvent(EventTranslatorTwoArg&lt;T, A, B&gt; eventTranslator, A arg0, B arg1) &#123;</div><div class="line">        this.ringBuffer.publishEvent(eventTranslator, arg0, arg1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public &lt;A, B, C&gt; void publishEvent(EventTranslatorThreeArg&lt;T, A, B, C&gt; eventTranslator, A arg0, B arg1, C arg2) &#123;</div><div class="line">        this.ringBuffer.publishEvent(eventTranslator, arg0, arg1, arg2);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RingBuffer&lt;T&gt; start() &#123;//遍历消费者，启动消费者线程</div><div class="line">        this.checkOnlyStartedOnce();</div><div class="line">        Iterator var1 = this.consumerRepository.iterator();</div><div class="line">        while(var1.hasNext()) &#123;</div><div class="line">            ConsumerInfo consumerInfo = (ConsumerInfo)var1.next();</div><div class="line">            consumerInfo.start(this.executor);</div><div class="line">        &#125; </div><div class="line">        return this.ringBuffer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void halt() &#123;</div><div class="line">        Iterator var1 = this.consumerRepository.iterator();</div><div class="line">        while(var1.hasNext()) &#123;</div><div class="line">            ConsumerInfo consumerInfo = (ConsumerInfo)var1.next();</div><div class="line">            consumerInfo.halt();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void shutdown() &#123;</div><div class="line">        try &#123;</div><div class="line">            this.shutdown(-1L, TimeUnit.MILLISECONDS);</div><div class="line">        &#125; catch (TimeoutException var2) &#123;</div><div class="line">            this.exceptionHandler.handleOnShutdownException(var2);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void shutdown(long timeout, TimeUnit timeUnit) throws TimeoutException &#123;</div><div class="line">        long timeOutAt = System.currentTimeMillis() + timeUnit.toMillis(timeout);</div><div class="line">        do &#123;</div><div class="line">            if(!this.hasBacklog()) &#123;</div><div class="line">                this.halt();</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125; while(timeout &lt; 0L || System.currentTimeMillis() &lt;= timeOutAt); </div><div class="line">        throw TimeoutException.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RingBuffer&lt;T&gt; getRingBuffer() &#123;</div><div class="line">        return this.ringBuffer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getCursor() &#123;</div><div class="line">        return this.ringBuffer.getCursor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getBufferSize() &#123;</div><div class="line">        return (long)this.ringBuffer.getBufferSize();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public T get(long sequence) &#123;</div><div class="line">        return this.ringBuffer.get(sequence);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SequenceBarrier getBarrierFor(EventHandler&lt;T&gt; handler) &#123;</div><div class="line">        return this.consumerRepository.getBarrierFor(handler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public long getSequenceValueFor(EventHandler&lt;T&gt; b1) &#123;</div><div class="line">        return this.consumerRepository.getSequenceFor(b1).get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private boolean hasBacklog() &#123;</div><div class="line">        long cursor = this.ringBuffer.getCursor();</div><div class="line">        Sequence[] var3 = this.consumerRepository.getLastSequenceInChain(false);</div><div class="line">        int var4 = var3.length;</div><div class="line">        for(int var5 = 0; var5 &lt; var4; ++var5) &#123;</div><div class="line">            Sequence consumer = var3[var5];</div><div class="line">            if(cursor &gt; consumer.get()) &#123;</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //1、创建BatchEventProcessor</div><div class="line">    //2、更新gatingSequence：取消跟踪barrierSequences，添加跟踪每个BatchEventProcessor(eventHandler).getSequence</div><div class="line">    //3、new EventHandlerGroup(consumerRepository.add(batchEventProcessor),Processor.getSequence())</div><div class="line">    EventHandlerGroup&lt;T&gt; createEventProcessors(Sequence[] barrierSequences, EventHandler&lt;? super T&gt;[] eventHandlers) &#123;</div><div class="line">        this.checkNotStarted();//检查是否已启动，启动后不能添加handler，抛异常</div><div class="line">        Sequence[] processorSequences = new Sequence[eventHandlers.length];</div><div class="line">        SequenceBarrier barrier = this.ringBuffer.newBarrier(barrierSequences);//一组handler共用一个序列屏障</div><div class="line">        int i = 0;</div><div class="line">        for(int eventHandlersLength = eventHandlers.length; i &lt; eventHandlersLength; ++i) &#123;</div><div class="line">            EventHandler eventHandler = eventHandlers[i];</div><div class="line">            BatchEventProcessor batchEventProcessor = new BatchEventProcessor(this.ringBuffer, barrier, eventHandler);//创建processor</div><div class="line">            if(this.exceptionHandler != null) &#123;</div><div class="line">                batchEventProcessor.setExceptionHandler(this.exceptionHandler);</div><div class="line">            &#125;</div><div class="line">            //添加到消费者仓库</div><div class="line">            this.consumerRepository.add(batchEventProcessor, eventHandler, barrier);</div><div class="line">            //获得processor记录的消费到的seq对象</div><div class="line">            processorSequences[i] = batchEventProcessor.getSequence();</div><div class="line">        &#125;</div><div class="line">        //更新Sequencer监听的消费者seq为最后一个消费者的seq，同时删除前置消费者的seq不再监听，修改前置消费者seq不为链上最后消费者seq</div><div class="line">        this.updateGatingSequencesForNextInChain(barrierSequences, processorSequences);</div><div class="line">        return new EventHandlerGroup(this, this.consumerRepository, processorSequences);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //只需保证最慢的消费者seq不被生产者覆盖，前置消费者的seq不需要监听</div><div class="line">    private void updateGatingSequencesForNextInChain(Sequence[] barrierSequences, Sequence[] processorSequences) &#123;</div><div class="line">        if(processorSequences.length &gt; 0) &#123;</div><div class="line">            this.ringBuffer.addGatingSequences(processorSequences);//seq晚于barrierSequences，只需保证最慢的消费者seq不被生产者覆盖</div><div class="line">            Sequence[] var3 = barrierSequences;</div><div class="line">            int var4 = barrierSequences.length;</div><div class="line">            for(int var5 = 0; var5 &lt; var4; ++var5) &#123;</div><div class="line">                Sequence barrierSequence = var3[var5];</div><div class="line">                this.ringBuffer.removeGatingSequence(barrierSequence);//只需保证最慢的消费者seq不被生产者覆盖</div><div class="line">            &#125;</div><div class="line">            //设置前置消费者seq不是链上最后一个消费者seq</div><div class="line">            this.consumerRepository.unMarkEventProcessorsAsEndOfChain(barrierSequences);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    EventHandlerGroup&lt;T&gt; createEventProcessors(Sequence[] barrierSequences, EventProcessorFactory&lt;T&gt;[] processorFactories) &#123;</div><div class="line">        EventProcessor[] eventProcessors = new EventProcessor[processorFactories.length];</div><div class="line">        for(int i = 0; i &lt; processorFactories.length; ++i) &#123;</div><div class="line">            eventProcessors[i] = processorFactories[i].createEventProcessor(this.ringBuffer, barrierSequences);</div><div class="line">        &#125;</div><div class="line">        return this.handleEventsWith(eventProcessors);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    EventHandlerGroup&lt;T&gt; createWorkerPool(Sequence[] barrierSequences, WorkHandler&lt;? super T&gt;[] workHandlers) &#123;</div><div class="line">        SequenceBarrier sequenceBarrier = this.ringBuffer.newBarrier(barrierSequences);</div><div class="line">        WorkerPool workerPool = new WorkerPool(this.ringBuffer, sequenceBarrier, this.exceptionHandler, workHandlers);</div><div class="line">        this.consumerRepository.add(workerPool, sequenceBarrier);</div><div class="line">        Sequence[] workerSequences = workerPool.getWorkerSequences();</div><div class="line">        this.updateGatingSequencesForNextInChain(barrierSequences, workerSequences);</div><div class="line">        return new EventHandlerGroup(this, this.consumerRepository, workerSequences);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void checkNotStarted() &#123;</div><div class="line">        if(this.started.get()) &#123;</div><div class="line">            throw new IllegalStateException(&quot;All event handlers must be added before calling starts.&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void checkOnlyStartedOnce() &#123;</div><div class="line">        if(!this.started.compareAndSet(false, true)) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Disruptor.start() must only be called once.&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;Disruptor&#123;ringBuffer=&quot; + this.ringBuffer + &quot;, started=&quot; + this.started + &quot;, executor=&quot; + this.executor + &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConsumerInfo"><a href="#ConsumerInfo" class="headerlink" title="ConsumerInfo"></a>ConsumerInfo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">interface ConsumerInfo &#123;</div><div class="line">    Sequence[] getSequences();</div><div class="line">    SequenceBarrier getBarrier();</div><div class="line">    boolean isEndOfChain();</div><div class="line">    void start(Executor var1);</div><div class="line">    void halt();</div><div class="line">    void markAsUsedInBarrier();</div><div class="line">    boolean isRunning();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="EventProcessorInfo"><a href="#EventProcessorInfo" class="headerlink" title="EventProcessorInfo"></a>EventProcessorInfo<t></t></h3><p> 有点像适配器模式，或者代理模式，代理EventProcessor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">class EventProcessorInfo&lt;T&gt; implements ConsumerInfo &#123;</div><div class="line">    private final EventProcessor eventprocessor;//事件处理线程</div><div class="line">    private final EventHandler&lt;? super T&gt; handler;//handler</div><div class="line">    private final SequenceBarrier barrier;</div><div class="line">    private boolean endOfChain = true;</div><div class="line"></div><div class="line">    EventProcessorInfo(EventProcessor eventprocessor, EventHandler&lt;? super T&gt; handler, SequenceBarrier barrier) &#123;</div><div class="line">        this.eventprocessor = eventprocessor;</div><div class="line">        this.handler = handler;</div><div class="line">        this.barrier = barrier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventProcessor getEventProcessor() &#123;</div><div class="line">        return this.eventprocessor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Sequence[] getSequences() &#123;</div><div class="line">        return new Sequence[]&#123;this.eventprocessor.getSequence()&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandler&lt;? super T&gt; getHandler() &#123;</div><div class="line">        return this.handler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SequenceBarrier getBarrier() &#123;</div><div class="line">        return this.barrier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean isEndOfChain() &#123;</div><div class="line">        return this.endOfChain;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void start(Executor executor) &#123;</div><div class="line">        executor.execute(this.eventprocessor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void halt() &#123;</div><div class="line">        this.eventprocessor.halt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void markAsUsedInBarrier() &#123;</div><div class="line">        this.endOfChain = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean isRunning() &#123;</div><div class="line">        return this.eventprocessor.isRunning();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WorkerPoolInfo"><a href="#WorkerPoolInfo" class="headerlink" title="WorkerPoolInfo"></a>WorkerPoolInfo<t></t></h3><p> 有点像适配器模式，或者代理模式，代理workerPool</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">class WorkerPoolInfo&lt;T&gt; implements ConsumerInfo &#123;</div><div class="line">    private final WorkerPool&lt;T&gt; workerPool;</div><div class="line">    private final SequenceBarrier sequenceBarrier;</div><div class="line">    private boolean endOfChain = true;</div><div class="line"></div><div class="line">    WorkerPoolInfo(WorkerPool&lt;T&gt; workerPool, SequenceBarrier sequenceBarrier) &#123;</div><div class="line">        this.workerPool = workerPool;</div><div class="line">        this.sequenceBarrier = sequenceBarrier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Sequence[] getSequences() &#123;</div><div class="line">        return this.workerPool.getWorkerSequences();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SequenceBarrier getBarrier() &#123;</div><div class="line">        return this.sequenceBarrier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean isEndOfChain() &#123;</div><div class="line">        return this.endOfChain;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void start(Executor executor) &#123;</div><div class="line">        this.workerPool.start(executor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void halt() &#123;</div><div class="line">        this.workerPool.halt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void markAsUsedInBarrier() &#123;</div><div class="line">        this.endOfChain = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean isRunning() &#123;</div><div class="line">        return this.workerPool.isRunning();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ConsumerRepository"><a href="#ConsumerRepository" class="headerlink" title="ConsumerRepository"></a>ConsumerRepository<t></t></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">class ConsumerRepository&lt;T&gt; implements Iterable&lt;ConsumerInfo&gt; &#123;</div><div class="line">    private final Map&lt;EventHandler&lt;?&gt;, EventProcessorInfo&lt;T&gt;&gt; eventProcessorInfoByEventHandler = new IdentityHashMap();//handler与Processor的一对一map</div><div class="line">    private final Map&lt;Sequence, ConsumerInfo&gt; eventProcessorInfoBySequence = new IdentityHashMap();//seq与processor的一对一map</div><div class="line">    private final Collection&lt;ConsumerInfo&gt; consumerInfos = new ArrayList();//processor</div><div class="line"></div><div class="line">    ConsumerRepository() &#123;</div><div class="line">    &#125;</div><div class="line">    //添加processor</div><div class="line">    public void add(EventProcessor eventprocessor, EventHandler&lt;? super T&gt; handler, SequenceBarrier barrier) &#123;</div><div class="line">        EventProcessorInfo consumerInfo = new EventProcessorInfo(eventprocessor, handler, barrier);</div><div class="line">        this.eventProcessorInfoByEventHandler.put(handler, consumerInfo);</div><div class="line">        this.eventProcessorInfoBySequence.put(eventprocessor.getSequence(), consumerInfo);</div><div class="line">        this.consumerInfos.add(consumerInfo);</div><div class="line">    &#125;</div><div class="line">    //添加processor</div><div class="line">    public void add(EventProcessor processor) &#123;</div><div class="line">        EventProcessorInfo consumerInfo = new EventProcessorInfo(processor, (EventHandler)null, (SequenceBarrier)null);</div><div class="line">        this.eventProcessorInfoBySequence.put(processor.getSequence(), consumerInfo);</div><div class="line">        this.consumerInfos.add(consumerInfo);</div><div class="line">    &#125;</div><div class="line">    //添加WorkerPool</div><div class="line">    public void add(WorkerPool&lt;T&gt; workerPool, SequenceBarrier sequenceBarrier) &#123;</div><div class="line">        WorkerPoolInfo workerPoolInfo = new WorkerPoolInfo(workerPool, sequenceBarrier);</div><div class="line">        this.consumerInfos.add(workerPoolInfo);</div><div class="line">        Sequence[] var4 = workerPool.getWorkerSequences();//每个processor的seq及公共workSeq</div><div class="line">        int var5 = var4.length;</div><div class="line"></div><div class="line">        for(int var6 = 0; var6 &lt; var5; ++var6) &#123;</div><div class="line">            Sequence sequence = var4[var6];</div><div class="line">            this.eventProcessorInfoBySequence.put(sequence, workerPoolInfo);//processor的Seq及workSeq都指向workerPoolInfo</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    //获得处理链上的最后一个消费者消费到的Seqs</div><div class="line">    public Sequence[] getLastSequenceInChain(boolean includeStopped) &#123;//是否包含已停止的消费者</div><div class="line">        ArrayList lastSequence = new ArrayList();</div><div class="line">        Iterator var3 = this.consumerInfos.iterator();</div><div class="line"></div><div class="line">        while(true) &#123;</div><div class="line">            ConsumerInfo consumerInfo;</div><div class="line">            do &#123;</div><div class="line">                if(!var3.hasNext()) &#123;//消费者为空，遍历完成</div><div class="line">                    return (Sequence[])lastSequence.toArray(new Sequence[lastSequence.size()]);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                consumerInfo = (ConsumerInfo)var3.next();//不为空则取出消费者</div><div class="line">            &#125; while(!includeStopped &amp;&amp; !consumerInfo.isRunning());//如不包含已停止的，且已停止，继续遍历直到碰到未停止的，判断是否是最后一个消费者，如果包含已停止的，则继续下面的代码</div><div class="line"></div><div class="line">            if(consumerInfo.isEndOfChain()) &#123;//是否是最后一个消费者</div><div class="line">                Sequence[] sequences = consumerInfo.getSequences();//获得当前处理到的seq，如果是BatchEventProcess数量为1，如果是WorkerPool则为多个：每个Processor的Seq+workSeq</div><div class="line">                Collections.addAll(lastSequence, sequences);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventProcessor getEventProcessorFor(EventHandler&lt;T&gt; handler) &#123;</div><div class="line">        EventProcessorInfo eventprocessorInfo = this.getEventProcessorInfo(handler);</div><div class="line">        if(eventprocessorInfo == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;The event handler &quot; + handler + &quot; is not processing events.&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            return eventprocessorInfo.getEventProcessor();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Sequence getSequenceFor(EventHandler&lt;T&gt; handler) &#123;</div><div class="line">        return this.getEventProcessorFor(handler).getSequence();</div><div class="line">    &#125;</div><div class="line">    //设置这些Processor不为最后一个Processor</div><div class="line">    public void unMarkEventProcessorsAsEndOfChain(Sequence... barrierEventProcessors) &#123;</div><div class="line">        Sequence[] var2 = barrierEventProcessors;</div><div class="line">        int var3 = barrierEventProcessors.length;</div><div class="line"></div><div class="line">        for(int var4 = 0; var4 &lt; var3; ++var4) &#123;</div><div class="line">            Sequence barrierEventProcessor = var2[var4];</div><div class="line">            this.getEventProcessorInfo(barrierEventProcessor).markAsUsedInBarrier();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Iterator&lt;ConsumerInfo&gt; iterator() &#123;</div><div class="line">        return this.consumerInfos.iterator();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SequenceBarrier getBarrierFor(EventHandler&lt;T&gt; handler) &#123;</div><div class="line">        EventProcessorInfo consumerInfo = this.getEventProcessorInfo(handler);</div><div class="line">        return consumerInfo != null?consumerInfo.getBarrier():null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private EventProcessorInfo&lt;T&gt; getEventProcessorInfo(EventHandler&lt;T&gt; handler) &#123;</div><div class="line">        return (EventProcessorInfo)this.eventProcessorInfoByEventHandler.get(handler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private ConsumerInfo getEventProcessorInfo(Sequence barrierEventProcessor) &#123;</div><div class="line">        return (ConsumerInfo)this.eventProcessorInfoBySequence.get(barrierEventProcessor);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="EventHandlerGroup"><a href="#EventHandlerGroup" class="headerlink" title="EventHandlerGroup"></a>EventHandlerGroup<t></t></h2><p>消费者组，维护consumerRepository与Sequence[]（每个消费者（Processor）处理到的seq） </p>
<ol>
<li>必须先通过Disruptor.handleEventsWith等方法实例化EventHandlerGroup，再调用其相应的方法</li>
<li>handleEventsWith()：添加handler，实际是调用disruptor.createEventProcessors创建BatchEventProcessor或disruptor.createWorkerPool创建WorkPool，更新是否为EndChain及gatingSequence</li>
<li>and()：合并EventHandlerGroup / 添加EventProcessor，更新consumerRepository及Sequence[]</li>
<li>then()：添加后置消费者，实际调用handleEventsWith()<ol>
<li>创建Barrier，调用disruptor.getRingBuffer().newBarrier(this.sequences);</li>
</ol>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"> public class EventHandlerGroup&lt;T&gt; &#123;   </div><div class="line">    private final Disruptor&lt;T&gt; disruptor;</div><div class="line">    private final ConsumerRepository&lt;T&gt; consumerRepository;</div><div class="line">    private final Sequence[] sequences;</div><div class="line"></div><div class="line">    EventHandlerGroup(Disruptor&lt;T&gt; disruptor, ConsumerRepository&lt;T&gt; consumerRepository, Sequence[] sequences) &#123;</div><div class="line">        this.disruptor = disruptor;</div><div class="line">        this.consumerRepository = consumerRepository;</div><div class="line">        this.sequences = (Sequence[])Arrays.copyOf(sequences, sequences.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; and(EventHandlerGroup&lt;T&gt; otherHandlerGroup) &#123;</div><div class="line">        Sequence[] combinedSequences = new Sequence[this.sequences.length + otherHandlerGroup.sequences.length];</div><div class="line">        System.arraycopy(this.sequences, 0, combinedSequences, 0, this.sequences.length);</div><div class="line">        System.arraycopy(otherHandlerGroup.sequences, 0, combinedSequences, this.sequences.length, otherHandlerGroup.sequences.length);</div><div class="line">        return new EventHandlerGroup(this.disruptor, this.consumerRepository, combinedSequences);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; and(EventProcessor... processors) &#123;</div><div class="line">        Sequence[] combinedSequences = new Sequence[this.sequences.length + processors.length];</div><div class="line"></div><div class="line">        for(int i = 0; i &lt; processors.length; ++i) &#123;</div><div class="line">            this.consumerRepository.add(processors[i]);</div><div class="line">            combinedSequences[i] = processors[i].getSequence();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.arraycopy(this.sequences, 0, combinedSequences, processors.length, this.sequences.length);</div><div class="line">        return new EventHandlerGroup(this.disruptor, this.consumerRepository, combinedSequences);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; then(EventHandler... handlers) &#123;</div><div class="line">        return this.handleEventsWith(handlers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; then(EventProcessorFactory... eventProcessorFactories) &#123;</div><div class="line">        return this.handleEventsWith(eventProcessorFactories);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; thenHandleEventsWithWorkerPool(WorkHandler... handlers) &#123;</div><div class="line">        return this.handleEventsWithWorkerPool(handlers);</div><div class="line">    &#125;</div><div class="line">    //添加handler</div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWith(EventHandler... handlers) &#123;</div><div class="line">        return this.disruptor.createEventProcessors(this.sequences, handlers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWith(EventProcessorFactory... eventProcessorFactories) &#123;</div><div class="line">        return this.disruptor.createEventProcessors(this.sequences, eventProcessorFactories);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public EventHandlerGroup&lt;T&gt; handleEventsWithWorkerPool(WorkHandler... handlers) &#123;</div><div class="line">        return this.disruptor.createWorkerPool(this.sequences, handlers);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SequenceBarrier asSequenceBarrier() &#123;</div><div class="line">        return this.disruptor.getRingBuffer().newBarrier(this.sequences);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="使用样例"><a href="#使用样例" class="headerlink" title="使用样例"></a>使用样例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public static void main(String[] args) &#123;</div><div class="line">        ThreadFactory threadFactory=Executors.defaultThreadFactory();</div><div class="line">        int bufferSize = 1024;</div><div class="line">        Disruptor&lt;EventEntity&gt; disruptor=new Disruptor&lt;EventEntity&gt;(new TrapEventFactory(),bufferSize,threadFactory);</div><div class="line">        Disruptor&lt;EventEntity&gt; disruptor2=new Disruptor&lt;EventEntity&gt;(new TrapEventFactory(),bufferSize,threadFactory);</div><div class="line">		//接收disruptor的消息进行过滤后，让如disruptor2</div><div class="line">        FlitHandler flitHandler=new FlitHandler(disruptor2);</div><div class="line">        ConversionHandler conversionHandler=new ConversionHandler();</div><div class="line">        EnrichHandler enrichHandler=new EnrichHandler();</div><div class="line">        SendHandler sendHandler=new SendHandler();</div><div class="line">        disruptor.handleEventsWith(flitHandler);</div><div class="line">        //先执行conversionHandler,enrichHandler，最后执行sendHandler</div><div class="line">        disruptor2.handleEventsWith(conversionHandler,enrichHandler).then(sendHandler);</div><div class="line">        disruptor.start();</div><div class="line">        disruptor2.start();</div><div class="line">        log.info(&quot;disruptor start&quot;);</div><div class="line">        //生产者</div><div class="line">        Executor executor = Executors.newFixedThreadPool(10);</div><div class="line">        EventProducer producer = new EventProducer(disruptor);</div><div class="line">        executor.execute(producer);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2017/08/27/Create-a-Blog-with-Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/27/Create-a-Blog-with-Hexo/" itemprop="url">Create a Blog with Hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-27T22:00:05+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/27/Create-a-Blog-with-Hexo/" class="leancloud_visitors" data-flag-title="Create a Blog with Hexo">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>记录使用hexo搭建个人博客的过程，及对使用的技术的学习</p>
<h1 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h1><p>静态网页博客系统，依赖nodejs，具体安装过程省略。</p>
<h1 id="next"><a href="#next" class="headerlink" title="next"></a>next</h1><p>hexo主题，本站在此基础上进行修改，并上传到github进行代码托管，在myblog中作为子模块引用，具体修改内容参考笔记：<a href="http://rockynote.com/2017/08/22/Optimizing-Hexo-with-Next-Theme">Optimizing Hexo with Next Theme</a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/27/Create-a-Blog-with-Hexo/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2017/08/27/Deploying-Hexo-to-Github-and-VPS-with-Travis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/27/Deploying-Hexo-to-Github-and-VPS-with-Travis/" itemprop="url">Deploying Hexo to Github and VPS with Travis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-27T21:49:11+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Travis/" itemprop="url" rel="index">
                    <span itemprop="name">Travis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/08/27/Deploying-Hexo-to-Github-and-VPS-with-Travis/" class="leancloud_visitors" data-flag-title="Deploying Hexo to Github and VPS with Travis">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>看到有文章推荐travis ci来自动部署hexo，折腾了几天，终于实现了，但只是一知半解，对个人理解做下记录。</p>
<p>环境：</p>
<ul>
<li>通过github同时备份hexo源代码（hexo分支）和网页文件（master分支）在一个仓库；</li>
<li>hexo工程通过子模块引用自己修改过的的next-xingsheq主题工程。</li>
</ul>
<p>目的：</p>
<ul>
<li>在push了hexo分支后，自动生成网页文件并自动部署到mater，同时部署到VPS。</li>
</ul>
<p>难点：</p>
<ul>
<li>travis需要获得github和VPS的读写权限，通过SSH公钥认证实现，本例中travis访问github和VPS使用一套公钥和私钥。</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/27/Deploying-Hexo-to-Github-and-VPS-with-Travis/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rockynote.com/2017/08/27/Managing-Hexo-Website-With-Github/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老祁">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老祁笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/27/Managing-Hexo-Website-With-Github/" itemprop="url">Managing Hexo Website With Github</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-27T21:43:59+08:00">
                2017-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Github/" itemprop="url" rel="index">
                    <span itemprop="name">Github</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/08/27/Managing-Hexo-Website-With-Github/" class="leancloud_visitors" data-flag-title="Managing Hexo Website With Github">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="create-hexo-project-at-PC"><a href="#create-hexo-project-at-PC" class="headerlink" title="create hexo project at PC"></a>create hexo project at PC</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir myblog</div><div class="line">cd myblog</div><div class="line">hexo init</div><div class="line">//启动测试</div><div class="line">hexo s</div></pre></td></tr></table></figure>
<h1 id="create-repository"><a href="#create-repository" class="headerlink" title="create repository"></a>create repository</h1><h2 id="create-repository-at-github-com"><a href="#create-repository-at-github-com" class="headerlink" title="create repository at github.com"></a>create repository at github.com</h2><p>Head over to <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a> and <a href="https://github.com/new" target="_blank" rel="noopener">create a new repository</a> named <em>username</em>.github.io, where <em>username</em> is your username (or organization name) on GitHub.</p>
<p>我有自己的VPS主机，不需要通过github访问，创建的是普通的repository,仓库名为myblog，如果需要通过github page访问，就要求创建的仓库名为： <em>username</em>.github.io</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/27/Managing-Hexo-Website-With-Github/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="老祁" />
          <p class="site-author-name" itemprop="name">老祁</p>
           
              <p class="site-description motion-element" itemprop="description">老祁的笔记</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xingsheq" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/iterator" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-link"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://qijiaoshou.com" title="祁较瘦" target="_blank">祁较瘦</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">老祁</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("XI4CVU7uevOpiu2KjmNMjcd4-gzGzoHsz", "tkrUmr1nl8g9tydH1yf7LJiQ");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
